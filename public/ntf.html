<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>S'abonner ntfy - hzflix</title>
  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding:20px; background:#f6f7f9; color:#111}
    .card{max-width:720px;margin:20px auto;padding:18px;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    button,a.button{display:inline-block;padding:10px 14px;border-radius:10px;background:#0057ff;color:#fff;text-decoration:none;border:0;font-weight:600}
    .qr{margin-top:12px;display:flex;gap:12px;align-items:center}
    .muted{color:#666;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <h3>S'abonner aux notifications ntfy (hzflix)</h3>
    <p class="muted">Cliquer ouvre l'application ntfy si elle est installée. Sinon fallback vers la page web et QR.</p>

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="openBtn">Ouvrir ntfy / S'abonner</button>
      <a id="webBtn" class="button" href="https://ntfy.sh/hzflix" style="background:#111">Ouvrir page web</a>
    </div>

    <div id="status" class="muted">Statut : en attente</div>

    <div class="qr">
      <img alt="QR ntfy hzflix" src="https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=https%3A%2F%2Fntfy.sh%2Fhzflix" width="120" height="120" />
      <div class="muted">QR vers <strong>https://ntfy.sh/hzflix</strong></div>
    </div>
  </div>

  <script>
    (function () {
      const topic = 'hzflix';
      const httpsUrl = `https://ntfy.sh/${encodeURIComponent(topic)}`;
      const intentUrl = `intent://ntfy.sh/${encodeURIComponent(topic)}#Intent;scheme=ntfy;package=io.adev.ntfy;end`;
      const openBtn = document.getElementById('openBtn');
      const status = document.getElementById('status');

      // heuristique delay avant fallback
      const FALLBACK_DELAY = 900;
      let visibilityChanged = false;

      function onVisibility() { visibilityChanged = true; }

      document.addEventListener('visibilitychange', onVisibility);

      function isAndroid() {
        return /android/i.test(navigator.userAgent);
      }
      function isIOS() {
        return /iphone|ipad|ipod/i.test(navigator.userAgent);
      }

      openBtn.addEventListener('click', function (e) {
        e.preventDefault();
        visibilityChanged = false;
        status.textContent = 'Statut : tentative d\'ouverture de l\'application...';

        const start = Date.now();

        if (isAndroid()) {
          // Essayer intent (Chrome Android). Si app installée, l'intent ouvrira l'app.
          // Sinon Chrome propose Play Store ou ne fait rien; on fallback vers https après délai.
          window.location.href = intentUrl;
        } else {
          // iOS : ouvrir l'universal link https pour que iOS route vers l'app si configurée.
          window.location.href = httpsUrl;
        }

        setTimeout(function () {
          if (visibilityChanged) {
            status.textContent = 'Statut : application ouverte';
            return;
          }

          // fallback : ouvrir la page web du topic (si l'app ne s'est pas ouverte)
          status.textContent = 'Statut : l\'application ne s\'est pas ouverte, ouverture du fallback web...';
          // On remplace la navigation uniquement si on n'a pas déjà basculé
          window.location.href = httpsUrl;
        }, FALLBACK_DELAY);
      });

      // nettoyage listener
      window.addEventListener('pagehide', () => {
        document.removeEventListener('visibilitychange', onVisibility);
      });
    })();
  </script>
</body>
</html>

