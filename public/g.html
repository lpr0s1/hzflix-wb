<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>SpaceGame — Système Solaire Réaliste</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
html,body{font-family:Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif;overflow:hidden;margin:0;height:100%;background:#000;-webkit-user-select:none;user-select:none}
canvas{display:block}
#loader{font-family:system-ui,Arial;position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;z-index:10}

.joystick{position:fixed;left:16px;bottom:16px;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,0.06);touch-action:none;z-index:9}
.joystick-inner{width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,0.18);position:relative;left:25px;top:25px;pointer-events:none}

.btn{position:fixed;width:60px;height:60px;border-radius:50%;background:rgba(255,255,255,0.08);text-align:center;line-height:60px;color:#fff;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:0.2s;z-index:9;}
.btn:hover{background:rgba(255,255,255,0.2);}

#galaxyLabel{position:fixed;left:50%;transform:translateX(-50%);top:16px;color:#0ff;padding:8px 12px;background:rgba(0,0,0,0.35);border-radius:8px;z-index:9;font-weight:bold;font-size:18px;text-shadow:0 0 8px #0ff;}
#gemCounter{position:fixed;top:16px;left:16px;background:linear-gradient(145deg,#0ff,#08f);padding:8px 14px;border-radius:12px;display:flex;align-items:center;color:#fff;font-weight:bold;font-size:18px;box-shadow:0 0 15px #0ff,0 0 30px #08f;z-index:9;animation:glow 2s infinite alternate;}
#gemCounter .material-icons{margin-right:6px; font-size:24px; color:#ff0;}

@keyframes glow{0%{box-shadow:0 0 15px #0ff,0 0 30px #08f;}100%{box-shadow:0 0 30px #0ff,0 0 50px #08f;}}

.progressBar{width:100%;height:10px;background:rgba(255,255,255,0.2);border-radius:5px;overflow:hidden}
.progressFill{height:100%;background:#4caf50;width:0%;transition:0.3s}

.shipItem{width:80px;height:80px;border-radius:12px;background:#111;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;transition:0.3s;}
.shipItem.locked{opacity:0.5;background:#222;}
.shipItem.selected{border:2px solid #4caf50;}
.lockIcon{position:absolute;top:4px;right:4px;font-size:20px;color:#fff;}

.popup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);color:#0ff;padding:20px;border-radius:12px;width:360px;z-index:20;transition:0.5s;box-shadow:0 0 20px #0ff;font-family:'Courier New', monospace;font-size:18px;text-shadow:0 0 6px #0ff;}
.popup h3{font-weight:bold;font-size:20px;margin-bottom:12px;text-align:center;}
.popup button{margin-top:12px;padding:6px 12px;border:none;border-radius:6px;background:#111;color:#0ff;font-weight:bold;cursor:pointer;transition:0.2s;}
.popup button:hover{background:#222;}

#shipList{display:flex;justify-content:space-around;margin-top:12px;}
#challengeNotif{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#111;color:#0ff;padding:12px 20px;border-radius:10px;opacity:0;pointer-events:none;transition:0.3s;z-index:21;text-shadow:0 0 8px #0ff;}

.galaxyBtn{display:block;margin:8px auto;padding:8px 14px;border-radius:6px;background:#111;color:#0ff;cursor:pointer;width:80%;text-align:center;transition:0.2s;}
.galaxyBtn:hover{background:#222;}
</style>
</head>
<body>

<div id="loader">Chargement...</div>
<div id="galaxyLabel">Infected galactic</div>
<div id="gemCounter"><span class="material-icons">diamond</span><span id="gemCount">0</span></div>

<div class="joystick" id="joystick"><div class="joystick-inner" id="joyInner"></div></div>
<div class="btn up" style="bottom: 96px; right: 16px;" id="btnUp"><span class="material-icons">arrow_upward</span></div>
<div class="btn down" style="bottom: 16px; right: 16px;" id="btnDown"><span class="material-icons">arrow_downward</span></div>
<div id="btnChallenge" class="btn" title="Défis" style="top:16px;right:16px;"><span class="material-icons">emoji_events</span></div>
<div id="btnInfo" class="btn" title="Infos" style="top:96px;right:16px;"><span class="material-icons">info</span></div>
<div id="btnShip" class="btn" title="Changer vaisseau" style="top:176px;right:16px;"><span class="material-icons">airplanemode_active</span></div>
<div id="btnWarp" class="btn" title="Ultra Propulsion" style="top:256px;right:16px;"><span class="material-icons">rocket_launch</span></div>

<!-- Popups -->
<div id="challengePopup" class="popup">
  <h3>Défis</h3>
  <div id="challengeList"><br><br></div>
  <br>
  <button id="closeChallenge">Fermer</button>
</div>
<div id="infoPopup" class="popup">
  <h3>Infos</h3>
  <hr>
  <p><b>Développeur:</b> Hz</p>
  <p><b>Version:</b> 1.0.3</p>
  <button id="closeInfo">Fermer</button>
</div>
<div id="shipPopup" class="popup">
  <h3>Vaisseaux</h3>
  <hr>
  <div id="shipList"></div>
  <button id="closeShip">Fermer</button>
</div>

<!-- Popup accueil -->
<div id="welcomePopup" class="popup">
  <h3>//1nc0nnu></h3>
  <small>telnet smtp.****.*** 25</small>
<small>HELO hzflix.online</small>
<small>MAIL FROM:< err0r@hz.err ></small>
<small style="display: flex;>RCPT TO: < ****@ you.com ></small>
  <p id="welcomeText"></p>
  <button id="closeWelcome">Fermer</button>
</div>

<!-- Popup Warp / Galaxies -->
<div id="warpPopup" class="popup">
  <h3>Sélectionner une galaxie</h3>
  <div id="galaxyButtons"></div>
  <button id="closeWarp">Fermer</button>
</div>

  <script>
fetch("https://api.ipify.org?format=json")
  .then(r => r.json())
  .then(data => {
      document.getElementById("ipk").textContent = "" + data.ip;
  })
</script>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';

// -------------------
// Charge textures
// -------------------
const loaderEl = document.getElementById('loader');
const galaxyLabel = document.getElementById('galaxyLabel');
const gemCountEl = document.getElementById('gemCount');
const texLoader = new THREE.TextureLoader();
async function loadSafe(url){return new Promise(resolve=>{texLoader.load(url,tex=>resolve(tex),undefined,()=>resolve(null));})}
const texMap = {
  mercury:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/mercury.jpg',
  venus:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/venus.jpg',
  earth:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/earth_atmos_2048.jpg',
  earthClouds:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/earth_clouds_1024.png',
  moon:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/moon_1024.jpg',
  mars:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/mars_1k_color.jpg',
  jupiter:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/jupiter.jpg',
  saturn:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/saturn.jpg',
  saturnRing:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/saturnringcolor.jpg',
  uranus:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/uranus.jpg',
  neptune:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/neptune.jpg',
  gem:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/sprites/spark1.png'
};
const textures = await Promise.all(Object.values(texMap).map(u=>loadSafe(u)));
const [mercuryTex,venusTex,earthTex,earthCloudsTex,moonTex,marsTex,jupiterTex,saturnTex,saturnRingTex,uranusTex,neptuneTex,gemTex] = textures;
loaderEl.style.display='none';

// -------------------
// Scene
// -------------------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000010);
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 20000);
camera.position.set(0,4,14);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio||1,2));
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);
scene.add(new THREE.AmbientLight(0x666666));
const sunLight = new THREE.PointLight(0xffffff,1.6,0); sunLight.position.set(0,0,0); scene.add(sunLight);
scene.add(new THREE.Mesh(new THREE.SphereGeometry(14,32,32), new THREE.MeshBasicMaterial({color:0xffee88})));

// -------------------
// Etoiles & poussière
// -------------------
function createRoundSprite(){
  const size=64,canvas=document.createElement('canvas'),ctx=canvas.getContext('2d');
  canvas.width=canvas.height=size;
  const grd=ctx.createRadialGradient(size/2,size/2,2,size/2,size/2,size/2);
  grd.addColorStop(0,'rgba(255,255,255,1)');grd.addColorStop(0.2,'rgba(160,200,255,1)');
  grd.addColorStop(0.4,'rgba(120,182,255,1)');grd.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=grd;ctx.fillRect(0,0,size,size);
  return new THREE.CanvasTexture(canvas);
}
const starSprite=createRoundSprite();
(function makeStars(){
  const layers=[{count:800,radiusMin:800,radiusMax:3000,size:14,twinkle:0.0002},{count:400,radiusMin:300,radiusMax:1400,size:10,twinkle:0.0004}];
  window._starFields=[];
  for(const L of layers){
    const geom=new THREE.BufferGeometry();
    const positions=new Float32Array(L.count*3);
    for(let i=0;i<L.count;i++){
      const r=L.radiusMin+Math.random()*(L.radiusMax-L.radiusMin);
      const theta=Math.random()*Math.PI*2;
      const phi=(Math.random()-0.5)*Math.PI;
      positions[i*3]=Math.cos(theta)*Math.cos(phi)*r;
      positions[i*3+1]=Math.sin(phi)*r;
      positions[i*3+2]=Math.sin(theta)*Math.cos(phi)*r;
    }
    geom.setAttribute('position', new THREE.BufferAttribute(positions,3));
    const mat=new THREE.PointsMaterial({map:starSprite,size:L.size,transparent:true,opacity:0.85,depthWrite:false,blending:THREE.AdditiveBlending});
    const points=new THREE.Points(geom,mat); scene.add(points);
    window._starFields.push({points,mat,twinkle:L.twinkle});
  }
})();
(function makeDust(){
  const count=1500,geom=new THREE.BufferGeometry(),pos=new Float32Array(count*3);
  for(let i=0;i<count;i++){
    const r=50+Math.random()*2500,theta=Math.random()*Math.PI*2,phi=(Math.random()-0.5)*Math.PI;
    pos[i*3]=Math.cos(theta)*Math.cos(phi)*r;
    pos[i*3+1]=Math.sin(phi)*r*0.2;
    pos[i*3+2]=Math.sin(theta)*Math.cos(phi)*r;
  }
  geom.setAttribute('position',new THREE.BufferAttribute(pos,3));
  scene.add(new THREE.Points(geom,new THREE.PointsMaterial({size:1.2,transparent:true,opacity:0.12,depthWrite:false,blending:THREE.AdditiveBlending,color:0xfff7ef})));
})();
  // -------------------
// Planètes et système solaire
// -------------------
const planets = [];
function makePlanet(name,radius,distance,texture,opts={}){
  const geom = new THREE.SphereGeometry(radius, opts.segments||32, opts.segments||32);
  const matOpts = {metalness:0.02,roughness:0.7};
  if(texture) matOpts.map = texture; else matOpts.color = opts.color||0x999999;
  const mesh = new THREE.Mesh(geom, new THREE.MeshStandardMaterial(matOpts));
  mesh.position.set(distance,0,0);
  mesh.userData = {name,distance,orbitalSpeed:(opts.orbitalPeriod?1/opts.orbitalPeriod:0.00005+Math.random()*0.0001)*0.4,rotationSpeed:opts.rotationSpeed||0.0005};
  if(opts.ring){
    const ringGeo = new THREE.RingGeometry(opts.ring.inner||radius*1.2, opts.ring.outer||radius*2, 128);
    const ringMat = new THREE.MeshBasicMaterial({map:opts.ring.map||null, side:THREE.DoubleSide, transparent:true, opacity:0.9});
    const ring = new THREE.Mesh(ringGeo, ringMat); 
    ring.rotation.x = Math.PI/2.2; ring.position.copy(mesh.position); scene.add(ring); 
    mesh.userData.ring = ring;
  }
  mesh.userData.rotationAxis = new THREE.Vector3(Math.random(),Math.random(),Math.random()).normalize();
  scene.add(mesh); 
  return mesh;
}

// Système solaire
planets.push(makePlanet('Mercure',4,70,mercuryTex,{orbitalPeriod:88,rotationSpeed:0.0008}));
planets.push(makePlanet('Vénus',6.8,90,venusTex,{orbitalPeriod:225,rotationSpeed:0.0002}));
const earth = makePlanet('Terre',9.7,120,earthTex,{orbitalPeriod:365,rotationSpeed:0.001}); planets.push(earth);
if(earthCloudsTex){
  const clouds = new THREE.Mesh(new THREE.SphereGeometry(2.06,32,32), new THREE.MeshPhongMaterial({map:earthCloudsTex,transparent:true,opacity:0.9,depthWrite:false}));
  earth.add(clouds);
}
const moon = new THREE.Mesh(new THREE.SphereGeometry(0.54,24,24), new THREE.MeshStandardMaterial({map:moonTex}));
moon.position.set(4.5,0,0); earth.add(moon); moon.userData={orbitSpeed:0.01,distance:4.5,angle:0};
planets.push(makePlanet('Mars',6.1,261,marsTex,{orbitalPeriod:687,rotationSpeed:0.001}));
planets.push(makePlanet('Jupiter',5.5,185,jupiterTex,{orbitalPeriod:4333,rotationSpeed:0.002}));
planets.push(makePlanet('Saturne',9.8,212,saturnTex,{orbitalPeriod:10759,rotationSpeed:0.0015,ring:{inner:6,outer:9,map:saturnRingTex}}));
planets.push(makePlanet('Uranus',4,327,uranusTex,{orbitalPeriod:30687,rotationSpeed:0.0008}));
planets.push(makePlanet('Neptune',2.9,352,neptuneTex,{orbitalPeriod:60190,rotationSpeed:0.0009}));
planets.push(makePlanet('Pluton',1.5,380,null,{orbitalPeriod:90560,rotationSpeed:0.0004,color:0x9b7b6a}));

// Planètes aléatoires supplémentaires
for(let i=0;i<25;i++){
  const radius = 1+Math.random()*5;
  const distance = 400+Math.random()*2500;
  const color = Math.random()*0xffffff;
  const planet = makePlanet('Planète'+i, radius, distance, null, {color: color, rotationSpeed: 0.0005+Math.random()*0.001});
  planets.push(planet);
}

// -------------------
// Galaxies et gemmes
// -------------------
const galaxies = [
  {name:'Milky Way', offset: new THREE.Vector3(0,0,0), gems: []},
  {name:'Andromeda', offset: new THREE.Vector3(5000,0,0), gems: []},
  {name:'Triangulum', offset: new THREE.Vector3(-5000,0,0), gems: []}
];
let currentGalaxy = 0;
let totalGemsCollected = 0;
function spawnGems(galaxy){
  const gemCount = Math.min(500, Math.floor(Math.random()*150)+50);
  for(let i=0;i<gemCount;i++){
    const g = new THREE.Mesh(new THREE.SphereGeometry(1,12,12), new THREE.MeshBasicMaterial({map:gemTex,transparent:true}));
    g.position.set(
      galaxy.offset.x + Math.random()*2000-1000,
      Math.random()*300-150,
      galaxy.offset.z + Math.random()*2000-1000
    );
    g.userData.collected = false;
    scene.add(g);
    galaxy.gems.push(g);
  }
}
galaxies.forEach(g => spawnGems(g));

// -------------------
// Vaisseaux stylés
// -------------------
let ships=[], currentShip=0, ship;
function createShip(type){
  const g = new THREE.Group();
  const mat = new THREE.MeshStandardMaterial({color:0x0ff,metalness:0.8,roughness:0.2,emissive:0x0088ff,emissiveIntensity:0.4});
  const body = new THREE.Mesh(new THREE.ConeGeometry(1,3,16), mat); body.rotation.x=Math.PI/2; g.add(body);
  const wingL = new THREE.Mesh(new THREE.BoxGeometry(0.3,0.1,1.5), mat); wingL.position.set(-0.8,0,0); g.add(wingL);
  const wingR = new THREE.Mesh(new THREE.BoxGeometry(0.3,0.1,1.5), mat); wingR.position.set(0.8,0,0); g.add(wingR);
  g.userData = {type};
  g.visible=false;
  return g;
}
ships.push(createShip('classic'));
ships.push(createShip('sleek'));
ships.push(createShip('bulky'));
ships[0].visible=true; ship=ships[0]; ship.position.set(28,6,12); scene.add(ship);

// -------------------
// Popups & UI
// -------------------
const shipPopup = document.getElementById('shipPopup');
const shipList = document.getElementById('shipList');
const btnShipPopup = document.getElementById('btnShip');
document.getElementById('closeShip').addEventListener('click',()=>shipPopup.style.display='none');
function updateShipPopup(){
  shipList.innerHTML='';
  ships.forEach((s,index)=>{
    const div = document.createElement('div');
    div.className='shipItem';
    if(index===currentShip) div.classList.add('selected');
    div.addEventListener('click',()=>{
      ships[currentShip].visible=false;
      currentShip=index;
      ship=ships[currentShip]; ship.visible=true;
      updateShipPopup();
      shipPopup.style.display='none';
    });
    shipList.appendChild(div);
  });
}
btnShipPopup.addEventListener('click',()=>{
  updateShipPopup();
  shipPopup.style.display='block';
});

// Défis
const challenges=[
  {name:"Parcourir 1000 km",target:1000,progress:0,done:false},
  {name:"Entrer dans 2 galaxies",target:2,progress:0,done:false},
  {name:"Débloquer vaisseau Sleek",target:1,progress:0,done:false},
  {name:"Débloquer vaisseau Bulky",target:2,progress:0,done:false},
  {name:"Collecter 50 gemmes",target:50,progress:0,done:false},
  {name:"Collecter 200 gemmes", target:200,progress:0,done:false}
];
const challengeListEl=document.getElementById('challengeList'),challengePopup=document.getElementById('challengePopup'),notifEl=document.getElementById('challengeNotif');
function updateChallengesUI(){
  challengeListEl.innerHTML='';
  challenges.forEach(c=>{
    const div=document.createElement('div');
    div.innerHTML=`<b>${c.name}</b> <span>${Math.min(c.progress,c.target)}/${c.target}</span>
      <div class="progressBar"><div class="progressFill" style="width:${(c.progress/c.target)*100}%"></div></div>`;
    challengeListEl.appendChild(div);
  });
}
function showNotif(text){
  notifEl.textContent=text;
  notifEl.style.opacity='1'; 
  setTimeout(()=>{notifEl.style.opacity='0';},2500);
}
document.getElementById('btnChallenge').addEventListener('click',()=>{updateChallengesUI(); challengePopup.style.display='block';});
document.getElementById('closeChallenge').addEventListener('click',()=>challengePopup.style.display='none');
document.getElementById('btnInfo').addEventListener('click',()=>document.getElementById('infoPopup').style.display='block');
document.getElementById('closeInfo').addEventListener('click',()=>document.getElementById('infoPopup').style.display='none');

// -------------------
// Popup accueil lettres animées
// -------------------
const welcomePopup = document.getElementById('welcomePopup');
const welcomeText = document.getElementById('welcomeText');
const closeWelcome = document.getElementById('closeWelcome');
closeWelcome.addEventListener('click',()=>{welcomePopup.style.display='none';});
const welcomeMessage = "<Collectez des gemmes (des étoiles a très faible lumière) pour débloquer de nouveaux vaisseaux.>";
function animateText(textEl,msg,duration){
  let i=0; const interval = duration/msg.length;
  const timer = setInterval(()=>{textEl.textContent+=msg[i]; i++; if(i>=msg.length) clearInterval(timer);},interval);
}
setTimeout(()=>{welcomePopup.style.display='block'; animateText(welcomeText,welcomeMessage,3000);},5000);

// -------------------
// Popup Warp / Galaxies
// -------------------
const warpPopup = document.getElementById('warpPopup');
const galaxyButtonsDiv = document.getElementById('galaxyButtons');
document.getElementById('btnWarp').addEventListener('click',()=>{
  galaxyButtonsDiv.innerHTML='';
  galaxies.forEach((g,i)=>{
    const btn = document.createElement('div');
    btn.className='galaxyBtn';
    btn.textContent=g.name;
    btn.addEventListener('click',()=>{warpToGalaxy(i); warpPopup.style.display='none';});
    galaxyButtonsDiv.appendChild(btn);
  });
  warpPopup.style.display='block';
});
document.getElementById('closeWarp').addEventListener('click',()=>warpPopup.style.display='none');
function warpToGalaxy(choice){
  if(choice===currentGalaxy) return;
  joy.style.pointerEvents='none'; move={x:0,y:0,up:false,down:false};
  const warpStart=Date.now(), warpDuration=1500;
  const startPos=ship.position.clone();
  const endPos=galaxies[choice].offset.clone().add(new THREE.Vector3(28,6,12));
  function warpAnim(){
    const t=(Date.now()-warpStart)/warpDuration;
    if(t>=1){ship.position.copy(endPos); currentGalaxy=choice; joy.style.pointerEvents='auto'; showNotif("Galaxie "+galaxies[choice].name); galaxyLabel.textContent = galaxies[choice].name;}
    else{ship.position.lerpVectors(startPos,endPos,t); requestAnimationFrame(warpAnim);}
  }
  warpAnim();
}

// -------------------
// Joystick & mouvements
// -------------------
let move={x:0,y:0,up:false,down:false};
const joy=document.getElementById('joystick'),joyInner=document.getElementById('joyInner');
joy.addEventListener('touchstart',e=>e.preventDefault());
joy.addEventListener('touchmove',e=>{
  const t=e.touches[0],r=joy.getBoundingClientRect();
  move.x=Math.max(-1,Math.min(1,(t.clientX-(r.left+r.width/2))/(r.width/2)));
  move.y=Math.max(-1,Math.min(1,-(t.clientY-(r.top+r.height/2))/(r.height/2)));
  joyInner.style.transform=`translate(${move.x*25}px, ${-move.y*25}px)`;
});
joy.addEventListener('touchend',()=>{move.x=0;move.y=0;joyInner.style.transform='translate(0,0)';});
document.getElementById('btnUp').addEventListener('touchstart',()=>move.up=true);
document.getElementById('btnUp').addEventListener('touchend',()=>move.up=false);
document.getElementById('btnDown').addEventListener('touchstart',()=>move.down=true);
document.getElementById('btnDown').addEventListener('touchend',()=>move.down=false);

// -------------------
// Animate loop
// -------------------
let velocity=new THREE.Vector3(), direction=new THREE.Vector3();
const forwardVec=new THREE.Vector3(0,0,-1);
planets.forEach(p=>{p.userData.angle=Math.random()*Math.PI*2;}); moon.userData.angle=0;
let totalDistance=0;
const lastPos=new THREE.Vector3().copy(ship.position);

function updateChallengeProgress(){
  const dist=lastPos.distanceTo(ship.position); totalDistance+=dist; lastPos.copy(ship.position);
  const d1=challenges[0]; if(!d1.done){d1.progress=totalDistance; if(d1.progress>=d1.target){d1.done=true; showNotif(`Défi terminé: ${d1.name}`);}}
  // Gemmes
  galaxies.forEach(g=>g.gems.forEach(gem=>{
    if(!gem.userData.collected && ship.position.distanceTo(gem.position)<3){
      gem.userData.collected=true; scene.remove(gem); totalGemsCollected++;
      gemCountEl.textContent = totalGemsCollected;
      if(!challenges[5].done){challenges[5].progress = totalGemsCollected; if(challenges[5].progress>=challenges[5].target){challenges[5].done=true; showNotif(`Défi terminé: ${challenges[5].name}`);}}
      showNotif("Gemme collectée!");
    }
  }));
  updateChallengesUI();
}

function animate(){
  requestAnimationFrame(animate);
  const now=Date.now();
  // Planètes
  planets.forEach(p=>{
    p.userData.angle+=p.userData.orbitalSpeed*0.2;
    const a=p.userData.angle,d=p.userData.distance;
    p.position.x=Math.cos(a)*d; p.position.z=Math.sin(a)*d;
    if(p.userData.ring)p.userData.ring.position.copy(p.position);
    p.rotation.y+=p.userData.rotationSpeed||0.0005;
    p.rotateOnAxis(p.userData.rotationAxis,0.002);
  });
  moon.userData.angle+=0.002; moon.position.x=Math.cos(moon.userData.angle)*moon.userData.distance; moon.position.z=Math.sin(moon.userData.angle)*moon.userData.distance;
  
  // Etoiles
  if(window._starFields)window._starFields.forEach((sf,i)=>{sf.mat.opacity=0.75+0.15*Math.sin(now*sf.twinkle*(i+1));});

  // Mouvement vaisseau
  direction.set(0,0,0); 
  const localF=forwardVec.clone().applyEuler(ship.rotation); direction.add(localF.multiplyScalar(move.y*0.45));
  if(move.up) direction.y+=0.12;
  if(move.down) direction.y-=0.12;
  velocity.lerp(direction,0.06); ship.position.add(velocity);
  ship.rotation.x=0; ship.rotation.z=0; ship.rotation.y-=move.x*0.04;

  const desired=ship.position.clone().add(new THREE.Vector3(0,2,8).applyEuler(ship.rotation)); 
  camera.position.lerp(desired,0.08); camera.lookAt(ship.position);
  renderer.render(scene,camera);

  updateChallengeProgress();
}
animate();
window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight);});
</script>
</body>
</html>
