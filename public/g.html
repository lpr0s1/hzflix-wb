<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>SpaceGame - Vaisseau Réel</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<style>
html,body{margin:0;height:100%;background:#000;color:#fff;font-family:sans-serif}
canvas{display:block}
#loader{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:10}
#loader-ok{margin-top:12px;color:#0f0;opacity:0;transition:opacity .3s}
.joystick{position:absolute;left:20px;bottom:20px;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,0.06);touch-action:none}
.joystick-inner{width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,0.18);position:relative;left:25px;top:25px;pointer-events:none}
.btn{position:absolute;width:60px;height:60px;border-radius:50%;background:rgba(255,255,255,0.12);text-align:center;line-height:60px;right:20px}
.btn.up{bottom:100px}.btn.down{bottom:20px}
</style>
</head>
<body>
<div id="loader">Chargement des ressources...<div id="loader-ok">✔ OK</div></div>
<div class="joystick" id="joystick"><div class="joystick-inner" id="joyInner"></div></div>
<div class="btn up" id="btnUp">↑</div>
<div class="btn down" id="btnDown">↓</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
import { GLTFLoader } from 'https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';

(async ()=> {
  const loaderDiv = document.getElementById('loader');
  const okDiv = document.getElementById('loader-ok');

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x000010);
  const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 5000);
  camera.position.set(0,3,10);

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(Math.min(devicePixelRatio||1,2));
  renderer.setSize(innerWidth, innerHeight);
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.AmbientLight(0x666666));
  const sun = new THREE.PointLight(0xffffff,2); sun.position.set(0,0,0); scene.add(sun);

  const texLoader = new THREE.TextureLoader();
  // textures en fallback si besoin
  let earth, clouds, moon;
  try {
    const earthTex = await texLoader.loadAsync('https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/earth_atmos_2048.jpg');
    earth = new THREE.Mesh(new THREE.SphereGeometry(5,64,64), new THREE.MeshPhongMaterial({map:earthTex}));
    earth.position.set(50,0,0); scene.add(earth);
    clouds = new THREE.Mesh(new THREE.SphereGeometry(5.05,64,64), new THREE.MeshPhongMaterial({transparent:true,opacity:0.9}));
    earth.add(clouds);
    moon = new THREE.Mesh(new THREE.SphereGeometry(1.3,32,32), new THREE.MeshPhongMaterial({color:0x888888}));
    moon.position.set(8,0,0); earth.add(moon);
  } catch(e){ console.warn('Textures failed, continuing without them', e); }

  // VRAI modèle GLB public
  const shipUrl = 'https://rawcdn.githack.com/zgk11/3D-model/main/ship.glb';
  const loader = new GLTFLoader();
  let ship = null;
  try {
    const gltf = await new Promise((res, rej) => loader.load(shipUrl, res, undefined, rej));
    ship = gltf.scene;
    ship.scale.set(0.6,0.6,0.6);
    ship.position.set(0,0,0);
    scene.add(ship);
  } catch(err) {
    console.error('GLTF load failed, using fallback geometry', err);
    const mat = new THREE.MeshStandardMaterial({color:0x88ccff});
    ship = new THREE.Group();
    const body = new THREE.Mesh(new THREE.ConeGeometry(0.8,2.5,16), mat); body.rotation.x = Math.PI/2;
    ship.add(body, new THREE.Mesh(new THREE.BoxGeometry(0.1,1.2,0.6), mat), new THREE.Mesh(new THREE.BoxGeometry(0.1,1.2,0.6), mat));
    scene.add(ship);
  }

  okDiv.style.opacity = '1';
  setTimeout(()=> loaderDiv.style.display='none', 350);

  // contrôles tactiles simples
  let move = {x:0,y:0,up:false,down:false};
  const joy = document.getElementById('joystick'), inner = document.getElementById('joyInner');
  function pointerToMove(cx,cy){
    const r = joy.getBoundingClientRect();
    const mx = (cx - (r.left + r.width/2)) / (r.width/2);
    const my = - (cy - (r.top + r.height/2)) / (r.height/2);
    move.x = Math.max(-1,Math.min(1,mx)); move.y = Math.max(-1,Math.min(1,my));
    inner.style.transform = `translate(${move.x*25}px, ${-move.y*25}px)`;
  }
  joy.addEventListener('pointerdown', e=>{ joy.setPointerCapture(e.pointerId); pointerToMove(e.clientX,e.clientY); });
  window.addEventListener('pointermove', e=>{ if(e.buttons) pointerToMove(e.clientX,e.clientY); });
  window.addEventListener('pointerup', ()=>{ move.x=0; move.y=0; inner.style.transform='translate(0,0)'; });

  document.getElementById('btnUp').addEventListener('pointerdown', ()=> move.up=true);
  document.getElementById('btnUp').addEventListener('pointerup', ()=> move.up=false);
  document.getElementById('btnDown').addEventListener('pointerdown', ()=> move.down=true);
  document.getElementById('btnDown').addEventListener('pointerup', ()=> move.down=false);

  const velocity = new THREE.Vector3(), direction = new THREE.Vector3(), forward = new THREE.Vector3(0,0,-1);
  function animate(){
    requestAnimationFrame(animate);
    if(earth){ const t = Date.now()*0.00005; earth.position.x = 50*Math.cos(t); earth.position.z = 50*Math.sin(t); }
    direction.set(0,0,0);
    direction.add(forward.clone().applyEuler(ship.rotation).multiplyScalar(move.y*0.25));
    if(move.up) direction.y += 0.12; if(move.down) direction.y -= 0.12;
    velocity.lerp(direction, 0.08); ship.position.add(velocity);
    ship.rotation.y -= move.x * 0.04;
    camera.position.lerp(ship.position.clone().add(new THREE.Vector3(0,3,8).applyEuler(ship.rotation)), 0.12);
    camera.lookAt(ship.position);
    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener('resize', ()=>{ camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); });

})();
</script>
</body>
</html>

