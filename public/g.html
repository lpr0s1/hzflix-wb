<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>SpaceGame - Galaxies & Turbo</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden;-webkit-user-select:none;user-select:none}
canvas{display:block}
#ui{position:fixed;left:12px;top:12px;z-index:30;color:#fff;font-family:system-ui,Arial;font-size:14px}
.button{display:inline-block;padding:8px 10px;margin:6px;background:rgba(255,255,255,0.06);border-radius:8px}
#loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-family:system-ui,Arial;z-index:40}
.joystick{position:fixed;left:16px;bottom:16px;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,0.04);touch-action:none;z-index:30}
.joystick-inner{width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,0.12);position:relative;left:25px;top:25px;pointer-events:none}
.btn{position:fixed;right:16px;width:60px;height:60px;border-radius:50%;background:rgba(255,255,255,0.06);text-align:center;line-height:60px;color:#fff;z-index:30}
.btn.up{bottom:96px}.btn.down{bottom:16px}
#turbo{position:fixed;right:12px;top:12px;padding:10px 12px;background:rgba(255,255,255,0.06);border-radius:8px;color:#fff;z-index:30}
#galaxySelect{position:fixed;left:12px;bottom:12px;padding:8px;background:rgba(255,255,255,0.04);border-radius:8px;color:#fff;z-index:30}
#speedDisplay{position:fixed;left:50%;transform:translateX(-50%);top:12px;color:#fff;z-index:30;font-family:system-ui,Arial}
</style>
</head>
<body>
<div id="loader">Chargement...</div>
<div id="ui">
  <span class="button" id="btnAddPlanet">+ Planète</span>
  <span class="button" id="btnRemovePlanet">- Planète</span>
</div>
<div id="galaxySelect">
  <select id="galaxy" style="background:transparent;color:#fff;border:0;font-size:14px">
    <option value="0">Galaxy A</option>
    <option value="1">Galaxy B</option>
    <option value="2">Galaxy C</option>
  </select>
</div>
<div id="speedDisplay">Vitesse: 1x</div>
<div id="turbo" class="button">TURBO</div>
<div class="joystick" id="joystick"><div class="joystick-inner" id="joyInner"></div></div>
<div class="btn up" id="btnUp">↑</div>
<div class="btn down" id="btnDown">↓</div>
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
import { RoundedBoxGeometry } from 'https://unpkg.com/three@0.152.2/examples/jsm/geometries/RoundedBoxGeometry.js';
import { SubdivisionModifier } from 'https://unpkg.com/three@0.152.2/examples/jsm/modifiers/SubdivisionModifier.js';
const loaderEl=document.getElementById('loader');
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x000010);
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,10000);
camera.position.set(0,4,12);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio||1,2));
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);
const ambient=new THREE.AmbientLight(0x666666);scene.add(ambient);
const sunLight=new THREE.PointLight(0xffffff,2);sunLight.position.set(0,0,0);scene.add(sunLight);
const starField=createStarField(3000);scene.add(starField);
const planets=[];
const galaxyConfigs=[
  {name:'Galaxy A',starColor:0x99ddff,planetPalette:[0x334455,0x556677,0x223344]},
  {name:'Galaxy B',starColor:0xffcc99,planetPalette:[0x443322,0x665544,0x332211]},
  {name:'Galaxy C',starColor:0xaaccff,planetPalette:[0x2b2b3b,0x4b4b5b,0x6b6b7b]}
];
let currentGalaxy=0;
function createStarField(count){
  const g=new THREE.BufferGeometry();
  const p=new Float32Array(count*3);
  for(let i=0;i<count;i++){p[i*3]=(Math.random()-0.5)*4000;p[i*3+1]=(Math.random()-0.5)*4000;p[i*3+2]=(Math.random()-0.5)*4000;}
  g.setAttribute('position',new THREE.BufferAttribute(p,3));
  return new THREE.Points(g,new THREE.PointsMaterial({color:galaxyConfigs[currentGalaxy].starColor,size:1.2,transparent:true,opacity:0.9}));
}
function addPlanet(size=3,distance=60,color=0x445566,hasRings=false){
  const geo=new THREE.SphereGeometry(size,64,64);
  const mat=new THREE.MeshStandardMaterial({color:color,metalness:0.2,roughness:0.7});
  const mesh=new THREE.Mesh(geo,mat);
  mesh.userData.orbitRadius=distance;
  mesh.userData.orbitSpeed=0.0005+Math.random()*0.0015;
  mesh.position.set(distance,0,0);
  if(hasRings){
    const ringGeo=new THREE.RingGeometry(size*1.2,size*1.8,64);
    const ringMat=new THREE.MeshStandardMaterial({color:0x222222,side:THREE.DoubleSide,transparent:true,opacity:0.6});
    const ring=new THREE.Mesh(ringGeo,ringMat);
    ring.rotation.x=Math.PI/2;
    mesh.add(ring);
  }
  scene.add(mesh);
  planets.push(mesh);
}
function clearPlanets(){for(const p of planets)scene.remove(p);planets.length=0;}
function populateGalaxy(index){
  clearPlanets();
  currentGalaxy=index;
  const cfg=galaxyConfigs[index];
  scene.remove(starField);
  const sf=createStarField(3000);
  scene.add(sf);
  for(let i=0;i<3;i++){
    const size=2+Math.random()*6;
    const dist=30+Math.random()*120;
    const color=cfg.planetPalette[i%cfg.planetPalette.length];
    addPlanet(size,dist,color,i===1);
  }
}
populateGalaxy(0);
function makeFlatShip(){
  const g=new THREE.Group();
  const bodyMat=new THREE.MeshStandardMaterial({color:0x222222,metalness:0.8,roughness:0.25});
  const panelMat=new THREE.MeshStandardMaterial({color:0x111111,metalness:0.6,roughness:0.3});
  const fus=new THREE.Mesh(new RoundedBoxGeometry(2.6,0.28,6,8,0.12),bodyMat);
  fus.position.set(0,0,0);
  g.add(fus);
  const cockpit=new THREE.Mesh(new RoundedBoxGeometry(1.2,0.18,1.6,6,0.08),new THREE.MeshPhysicalMaterial({color:0x111111,transmission:0.85,transparent:true,opacity:0.95,metalness:0.05,roughness:0.1}));
  cockpit.position.set(0,0.18,1.1);
  g.add(cockpit);
  const wingL=new THREE.Mesh(new RoundedBoxGeometry(0.6,0.08,3.2,6,0.06),panelMat);
  wingL.position.set(-1.6,0,0.2);wingL.rotation.y=0.08;g.add(wingL);
  const wingR=wingL.clone();wingR.position.set(1.6,0,0.2);wingR.rotation.y=-0.08;g.add(wingR);
  const detailGroup=new THREE.Group();
  for(let i=0;i<6;i++){
    const p=new THREE.Mesh(new RoundedBoxGeometry(0.18,0.02,0.6,4,0.02),panelMat);
    p.position.set(-1.0+0.4*i,0.16,-0.6);
    p.rotation.y=0.02*(i-3);
    detailGroup.add(p);
  }
  g.add(detailGroup);
  const thrusterL=new THREE.Mesh(new THREE.CylinderGeometry(0.22,0.22,0.9,24),new THREE.MeshStandardMaterial({color:0x111111,metalness:0.95,roughness:0.15}));
  thrusterL.rotation.x=Math.PI/2;thrusterL.position.set(-0.5,-0.1,-3.2);g.add(thrusterL);
  const thrusterR=thrusterL.clone();thrusterR.position.set(0.5,-0.1,-3.2);g.add(thrusterR);
  const nozzleL=new THREE.Mesh(new THREE.ConeGeometry(0.18,0.3,24),new THREE.MeshStandardMaterial({color:0x000000,metalness:1,roughness:0.05}));
  nozzleL.rotation.x=Math.PI/2;nozzleL.position.set(-0.5,-0.55,-3.2);g.add(nozzleL);
  const nozzleR=nozzleL.clone();nozzleR.position.set(0.5,-0.55,-3.2);g.add(nozzleR);
  const vents=new THREE.Group();
  for(let i=0;i<4;i++){
    const v=new THREE.Mesh(new RoundedBoxGeometry(0.12,0.02,0.6,4,0.01),panelMat);
    v.position.set(-1.0+0.66*i,0.02,2.0);v.rotation.y=0.02*(i-2);
    vents.add(v);
  }
  g.add(vents);
  g.userData={thrusters:[thrusterL,thrusterR],setTurboPower(p){for(const t of g.userData.thrusters){t.scale.z=1+ p*1.8}}};
  return g;
}
const ship=makeFlatShip();ship.position.set(0,0,0);scene.add(ship);
const exhaustGeo=new THREE.BufferGeometry();const eCount=200;const ePos=new Float32Array(eCount*3);for(let i=0;i<eCount;i++){ePos[i*3]=(Math.random()-0.5)*0.18;ePos[i*3+1]=-1.6-Math.random()*0.8;ePos[i*3+2]=-3.6-Math.random()*1.2}exhaustGeo.setAttribute('position',new THREE.BufferAttribute(ePos,3));const exhaustMat=new THREE.PointsMaterial({color:0xffb366,size:0.06,transparent:true,opacity:0.9,depthWrite:false});const exhaust=new THREE.Points(exhaustGeo,exhaustMat);ship.add(exhaust);
let move={x:0,y:0,up:false,down:false};
const joy=document.getElementById('joystick');const joyInner=document.getElementById('joyInner');
joy.addEventListener('touchstart',e=>e.preventDefault());
joy.addEventListener('touchmove',e=>{const t=e.touches[0];const r=joy.getBoundingClientRect();move.x=Math.max(-1,Math.min(1,(t.clientX-(r.left+r.width/2))/(r.width/2)));move.y=Math.max(-1,Math.min(1,-(t.clientY-(r.top+r.height/2))/(r.height/2)));joyInner.style.transform=`translate(${move.x*25}px, ${-move.y*25}px)`;});
joy.addEventListener('touchend',()=>{move.x=0;move.y=0;joyInner.style.transform='translate(0,0)';});
document.getElementById('btnUp').addEventListener('touchstart',()=>move.up=true);document.getElementById('btnUp').addEventListener('touchend',()=>move.up=false);
document.getElementById('btnDown').addEventListener('touchstart',()=>move.down=true);document.getElementById('btnDown').addEventListener('touchend',()=>move.down=false);
let velocity=new THREE.Vector3();let direction=new THREE.Vector3();const forward=new THREE.Vector3(0,0,-1);
let baseSpeed=0.25;let speedMultiplier=1;let turbo=false;const speedDisplay=document.getElementById('speedDisplay');
document.getElementById('turbo').addEventListener('touchstart',()=>{turbo=true;speedMultiplier=1000;speedDisplay.textContent='Vitesse: c';setTimeout(()=>{turbo=false;speedMultiplier=1;speedDisplay.textContent='Vitesse: 1x'},1200);});
document.getElementById('btnAddPlanet').addEventListener('click',()=>{const size=1+Math.random()*5;const dist=30+Math.random()*160;const color=galaxyConfigs[currentGalaxy].planetPalette[Math.floor(Math.random()*galaxyConfigs[currentGalaxy].planetPalette.length)];addPlanet(size,dist,color,Math.random()>0.6)});
document.getElementById('btnRemovePlanet').addEventListener('click',()=>{const p=planets.pop();if(p)scene.remove(p)});
document.getElementById('galaxy').addEventListener('change',(e)=>{populateGalaxy(parseInt(e.target.value));});
function animate(){
  requestAnimationFrame(animate);
  const t=Date.now()*0.00005;
  for(const p of planets){
    const r=p.userData.orbitRadius;const s=p.userData.orbitSpeed;
    p.position.x=Math.cos(t*s*100)*r; p.position.z=Math.sin(t*s*100)*r;
    p.rotation.y+=0.001;
  }
  starField.rotation.y+=0.00002*speedMultiplier;
  clouds && (clouds.rotation.y+=0.0006);
  direction.set(0,0,0);
  const localF=forward.clone().applyEuler(ship.rotation);
  direction.add(localF.multiplyScalar(move.y*baseSpeed*speedMultiplier));
  if(move.up)direction.y+=0.12*speedMultiplier;
  if(move.down)direction.y-=0.12*speedMultiplier;
  velocity.lerp(direction,0.08);
  ship.position.add(velocity);
  ship.rotation.y-=move.x*0.04;
  const thrusterPower=Math.min(1,Math.abs(move.y)*speedMultiplier);
  if(ship.userData && ship.userData.setTurboPower)ship.userData.setTurboPower(thrusterPower);
  if(ship.userData && ship.userData.setTurboPower===undefined && ship.userData.setTurboPower)ship.userData.setTurboPower(thrusterPower);
  if(ship.userData && ship.userData.setTurboPower===undefined && ship.userData.setThrusterPower)ship.userData.setThrusterPower(thrusterPower);
  if(ship.userData && ship.userData.setTurboPower===undefined && ship.userData.setThrusterPower===undefined && ship.userData.setTurboPower)ship.userData.setTurboPower(thrusterPower);
  exhaust.material.size=0.03+thrusterPower*0.12;exhaust.material.opacity=0.25+thrusterPower*0.75;
  const arr=exhaustGeo.attributes.position.array;
  for(let i=0;i<arr.length/3;i++){const idx=i*3;arr[idx]+= (Math.random()-0.5)*0.002*speedMultiplier;arr[idx+1]-=0.002-Math.random()*0.004;arr[idx+2]+=(Math.random()-0.5)*0.002;if(arr[idx+1]<-6.0)arr[idx+1]=-1.6-Math.random()*0.8}
  exhaustGeo.attributes.position.needsUpdate=true;
  const desired=ship.position.clone().add(new THREE.Vector3(0,3.2,8).applyEuler(ship.rotation));
  camera.position.lerp(desired,0.12);
  camera.lookAt(ship.position);
  renderer.render(scene,camera);
}
animate();
window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight)});
loaderEl.style.display='none';
</script>
</body>
</html>


