<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>SpaceGame Mobile 3D</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; background:black; overflow:hidden; }
canvas { display:block; }
#errorBox { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); color:#ff5555; font-family:sans-serif; font-size:16px; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; padding:20px; box-sizing:border-box; }
#errorBox pre { white-space: pre-wrap; text-align:left; max-width:80%; }
</style>
</head>
<body>
<div id="errorBox" style="display:none;">
  <h2>Une erreur est survenue</h2>
  <pre id="errorText"></pre>
</div>

<script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>

<script>
function showError(err){
  console.error(err);
  const box = document.getElementById('errorBox');
  const text = document.getElementById('errorText');
  box.style.display='flex';
  text.textContent = err.stack || err.message || err;
}

window.addEventListener('error', e => {
  e.preventDefault();
  showError(e.error || e.message || 'Erreur inconnue');
});

window.addEventListener('unhandledrejection', e => {
  e.preventDefault();
  showError(e.reason || 'Promise rejetée');
});

(async function(){
try {
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000010);
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 10000);
camera.position.set(0,5,15);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const ambient = new THREE.AmbientLight(0x666666); scene.add(ambient);
const sunLight = new THREE.PointLight(0xffffff,2,0,2); sunLight.position.set(0,0,0); scene.add(sunLight);

// étoiles
{
  const g=new THREE.BufferGeometry();
  const n=2000;
  const pos=new Float32Array(n*3);
  for(let i=0;i<n;i++){ pos[i*3]=(Math.random()-0.5)*2000; pos[i*3+1]=(Math.random()-0.5)*2000; pos[i*3+2]=(Math.random()-0.5)*2000; }
  g.setAttribute('position',new THREE.BufferAttribute(pos,3));
  scene.add(new THREE.Points(g,new THREE.PointsMaterial({color:0x99ddff,size:4,transparent:true,opacity:0.8})));
}

// Planète exemple
const texLoader = new THREE.TextureLoader();
const earthTexture = await new Promise((res,rej)=>{
  texLoader.load('https://cdn.apewebapps.com/threejs/163/examples/textures/planets/earth_atmos_2048.jpg',res,undefined,rej);
});
const earth = new THREE.Mesh(new THREE.SphereGeometry(2,32,32), new THREE.MeshPhongMaterial({map:earthTexture}));
earth.position.set(40,0,0);
scene.add(earth);

// --- Vaisseau ---
let ship = null;
const gltfLoader = new THREE.GLTFLoader();
ship = await new Promise((res,rej)=>{
  gltfLoader.load('https://raw.githubusercontent.com/lpr0s1/hzflix-wb/main/public/spaceship.glb',gltf=>res(gltf.scene), undefined, rej);
});
ship.scale.set(0.5,0.5,0.5);
scene.add(ship);

// --- Pilotage tactile ---
let move={x:0,y:0,up:false,down:false};
const joy=document.createElement('div');
joy.className='joystick';
const joyInner=document.createElement('div');
joyInner.className='joystick-inner';
joy.appendChild(joyInner);
document.body.appendChild(joy);

function createBtn(className,text,onStart,onEnd){
  const btn=document.createElement('div');
  btn.className='btn '+className;
  btn.textContent=text;
  document.body.appendChild(btn);
  btn.addEventListener('touchstart',onStart);
  btn.addEventListener('touchend',onEnd);
}
createBtn('up','↑',()=>move.up=true,()=>move.up=false);
createBtn('down','↓',()=>move.down=true,()=>move.down=false);

joy.addEventListener('touchstart',e=>e.preventDefault());
joy.addEventListener('touchmove',e=>{
  const t=e.touches[0];
  const r=joy.getBoundingClientRect();
  move.x=Math.max(-1,Math.min(1,(t.clientX-(r.left+r.width/2))/(r.width/2)));
  move.y=Math.max(-1,Math.min(1,-(t.clientY-(r.top+r.height/2))/(r.height/2)));
  joyInner.style.transform=`translate(${move.x*25}px, ${-move.y*25}px)`;
});
joy.addEventListener('touchend',()=>{move.x=0; move.y=0; joyInner.style.transform='translate(0,0)';});

let velocity = new THREE.Vector3();
const forward = new THREE.Vector3(0,0,-1);

function animate(){
  requestAnimationFrame(animate);
  if(ship){
    const dir = forward.clone().applyQuaternion(ship.quaternion).multiplyScalar(move.y*0.2);
    if(move.up) dir.y+=0.1;
    if(move.down) dir.y-=0.1;
    velocity.lerp(dir,0.05);
    ship.position.add(velocity);
    ship.rotation.y -= move.x*0.03;
    const camPos = ship.position.clone().add(new THREE.Vector3(0,3,8).applyQuaternion(ship.quaternion));
    camera.position.lerp(camPos,0.1);
    camera.lookAt(ship.position);
  }
  renderer.render(scene,camera);
}
animate();

window.addEventListener('resize',()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

} catch(e){ showError(e); }
})();
</script>
</body>
</html>
