<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <title>SpaceGame — vaisseau 3D public</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; background:black; -webkit-user-select:none; user-select:none; }
    canvas { display:block; }
    .joystick { position:absolute; bottom:20px; left:20px; width:100px; height:100px; border-radius:50%; background:rgba(255,255,255,0.1); touch-action:none; }
    .joystick-inner { position:absolute; width:50px; height:50px; border-radius:50%; background:rgba(255,255,255,0.3); top:25px; left:25px; pointer-events:none; }
    .btn { position:absolute; width:60px; height:60px; border-radius:50%; background:rgba(255,255,255,0.2); text-align:center; line-height:60px; font-weight:bold; color:white; touch-action:none; }
    .btn.up { bottom:100px; right:20px; }
    .btn.down { bottom:20px; right:20px; }
  </style>
</head>
<body>
  <div class="joystick" id="joystick"><div class="joystick-inner" id="joyInner"></div></div>
  <div class="btn up" id="btnUp">↑</div>
  <div class="btn down" id="btnDown">↓</div>

  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>

  <script>
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000010);
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 10000);
    camera.position.set(0, 5, 12);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const ambient = new THREE.AmbientLight(0x666666);
    scene.add(ambient);
    const sunLight = new THREE.PointLight(0xffffff, 1.2, 0, 2);
    scene.add(sunLight);

    const starGeom = new THREE.BufferGeometry();
    const starCount = 1500;
    const pos = new Float32Array(starCount * 3);
    for(let i=0;i<starCount;i++){
      pos[3*i]   = (Math.random()-0.5)*2000;
      pos[3*i+1] = (Math.random()-0.5)*2000;
      pos[3*i+2] = (Math.random()-0.5)*2000;
    }
    starGeom.setAttribute('position', new THREE.BufferAttribute(pos,3));
    scene.add(new THREE.Points(starGeom, new THREE.PointsMaterial({ color: 0x99ddff, size: 3, transparent:true, opacity:0.8 })));

    let ship = null;
    const loader = new THREE.GLTFLoader();
    loader.load(
      'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Avocado/glTF/Avocado.gltf', // exemple temporaire
      gltf => {
        ship = gltf.scene;
        ship.scale.set(0.5, 0.5, 0.5);
        scene.add(ship);
      },
      undefined,
      err => {
        console.error('Erreur chargement vaisseau', err);
      }
    );

    let move = { x:0, y:0, up:false, down:false };
    const joy = document.getElementById('joystick');
    const joyInner = document.getElementById('joyInner');
    joy.addEventListener('touchstart', e => e.preventDefault());
    joy.addEventListener('touchmove', e => {
      const t = e.touches[0];
      const r = joy.getBoundingClientRect();
      move.x = Math.max(-1, Math.min(1, (t.clientX - (r.left + r.width/2)) / (r.width/2)));
      move.y = Math.max(-1, Math.min(1, -(t.clientY - (r.top + r.height/2)) / (r.height/2)));
      joyInner.style.transform = `translate(${move.x*25}px, ${-move.y*25}px)`;
    });
    joy.addEventListener('touchend', () => { move.x=0; move.y=0; joyInner.style.transform='translate(0,0)'; });

    document.getElementById('btnUp').addEventListener('touchstart', () => move.up=true);
    document.getElementById('btnUp').addEventListener('touchend', () => move.up=false);
    document.getElementById('btnDown').addEventListener('touchstart', () => move.down=true);
    document.getElementById('btnDown').addEventListener('touchend', () => move.down=false);

    const velocity = new THREE.Vector3();
    const direction = new THREE.Vector3();
    const forward = new THREE.Vector3(0,0,-1);

    function animate(){
      requestAnimationFrame(animate);

      if(ship){
        direction.set(0,0,0);
        direction.add(forward.clone().applyQuaternion(ship.quaternion).multiplyScalar(move.y * 0.2));
        if(move.up) direction.y += 0.1;
        if(move.down) direction.y -= 0.1;
        velocity.lerp(direction, 0.08);
        ship.position.add(velocity);
        ship.rotation.y -= move.x * 0.03;

        camera.position.lerp(ship.position.clone().add(new THREE.Vector3(0, 3, 8).applyQuaternion(ship.quaternion)), 0.1);
        camera.lookAt(ship.position);
      }

      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
