<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>SpaceGame — Système Solaire Réaliste</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
html,body{font-family:Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif;overflow:hidden;margin:0;height:100%;background:#000;-webkit-user-select:none;user-select:none}
canvas{display:block}
#loader{font-family:system-ui,Arial;position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;z-index:10}
.joystick{position:fixed;left:16px;bottom:16px;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,0.06);touch-action:none}
.joystick-inner{width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,0.18);position:relative;left:25px;top:25px;pointer-events:none}
.btn{position:fixed;width:60px;height:60px;border-radius:50%;background:rgba(255,255,255,0.08);text-align:center;line-height:60px;color:#fff;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.btn.up{bottom:96px;right:16px}
.btn.down{bottom:16px;right:16px}
#galaxyLabel{position:fixed;left:50%;transform:translateX(-50%);top:16px;color:#fff;padding:8px 12px;background:rgba(0,0,0,0.35);border-radius:8px;z-index:9}
.progressBar{width:100%;height:10px;background:rgba(255,255,255,0.2);border-radius:5px;overflow:hidden}
.progressFill{height:100%;background:#4caf50;width:0%;transition:0.3s}
.material-icons{font-size:28px;}
  .shipItem{
  width:80px; height:80px; border-radius:12px; background:#111; display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;
  transition:0.3s;
}
.shipItem.locked{opacity:0.5; background:#222;}
.shipItem.selected{border:2px solid #4caf50;}
.shipItem .lockIcon{position:absolute;top:4px;right:4px;font-size:20px;color:#fff;}
</style>
</head>
<body>

<div id="loader">Chargement...</div>
<div id="galaxyLabel">Système solaire</div>

<div class="joystick" id="joystick"><div class="joystick-inner" id="joyInner"></div></div>
<div class="btn up" id="btnUp"><span class="material-icons">arrow_upward</span></div>
<div class="btn down" id="btnDown"><span class="material-icons">arrow_downward</span></div>
<div id="btnChallenge" class="btn" title="Défis" style="bottom:96px;right:96px;"><span class="material-icons">emoji_events</span></div>
<div id="btnInfo" class="btn" title="Infos" style="bottom:16px;right:96px;"><span class="material-icons">info</span></div>
<div id="btnShip" class="btn" title="Changer vaisseau" style="bottom:16px;right:176px;"><span class="material-icons">airplanemode_active</span></div>

<div id="challengePopup" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);color:#fff;padding:20px;border-radius:12px;width:300px;z-index:20;">
  <h3>Défis</h3>
  <div id="challengeList"></div>
  <button id="closeChallenge" style="margin-top:12px;padding:6px 12px;border:none;border-radius:6px;background:#555;color:#fff;">Fermer</button>
</div>

<div id="infoPopup" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);color:#fff;padding:20px;border-radius:12px;width:220px;z-index:20;">
  <h3>Infos</h3>
  <p>Développeur: Hz</p>
  <p>Version: 1.0.2</p>
  <button id="closeInfo" style="margin-top:12px;padding:6px 12px;border:none;border-radius:6px;background:#555;color:#fff;">Fermer</button>
</div>

<div id="challengeNotif" style="position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:12px 20px;border-radius:10px;opacity:0;pointer-events:none;transition:0.3s;z-index:21;"></div>

<!-- Popup Vaisseaux -->
<div id="shipPopup" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:#fff;padding:20px;border-radius:12px;width:320px;z-index:22;">
  <h3>Vaisseaux</h3>
  <div id="shipList" style="display:flex;justify-content:space-around;margin-top:12px;"></div>
  <button id="closeShip" style="margin-top:12px;padding:6px 12px;border:none;border-radius:6px;background:#555;color:#fff;">Fermer</button>
</div>
  
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';

const loaderEl = document.getElementById('loader');
const galaxyLabel = document.getElementById('galaxyLabel');
const texLoader = new THREE.TextureLoader();

async function loadSafe(url){return new Promise(resolve=>{texLoader.load(url,tex=>resolve(tex),undefined,()=>resolve(null));})}

const texMap = {
  mercury:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/mercury.jpg',
  venus:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/venus.jpg',
  earth:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/earth_atmos_2048.jpg',
  earthClouds:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/earth_clouds_1024.png',
  moon:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/moon_1024.jpg',
  mars:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/mars_1k_color.jpg',
  jupiter:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/jupiter.jpg',
  saturn:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/saturn.jpg',
  saturnRing:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/saturnringcolor.jpg',
  uranus:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/uranus.jpg',
  neptune:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/neptune.jpg',
  gem:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/sprites/spark1.png'
};

const textures = await Promise.all(Object.values(texMap).map(u=>loadSafe(u)));
const [mercuryTex,venusTex,earthTex,earthCloudsTex,moonTex,marsTex,jupiterTex,saturnTex,saturnRingTex,uranusTex,neptuneTex,gemTex] = textures;

loaderEl.style.display='none';

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000010);
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 20000);
camera.position.set(0,4,14);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio||1,2));
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

const ambient = new THREE.AmbientLight(0x666666); scene.add(ambient);
const sunLight = new THREE.PointLight(0xffffff,1.6,0); sunLight.position.set(0,0,0); scene.add(sunLight);
const sunMesh = new THREE.Mesh(new THREE.SphereGeometry(14,32,32), new THREE.MeshBasicMaterial({color:0xffee88}));
scene.add(sunMesh);


const shipPopup = document.getElementById('shipPopup');
const shipList = document.getElementById('shipList');
const btnShipPopup = document.getElementById('btnShip');
document.getElementById('closeShip').addEventListener('click',()=>shipPopup.style.display='none');

function updateShipPopup(){
  shipList.innerHTML='';
  ships.forEach((s,index)=>{
    const div = document.createElement('div');
    div.className='shipItem';
    if(index===currentShip) div.classList.add('selected');
    // Vérifier déblocage
    let unlocked=true;
    if(index===1 && !challenges[3].done) unlocked=false;
    if(index===2 && !challenges[4].done) unlocked=false;
    if(!unlocked){div.classList.add('locked'); div.innerHTML='<span class="material-icons lockIcon">lock</span>';}
    div.addEventListener('click',()=>{
      if(!unlocked) return;
      ships[currentShip].visible=false;
      currentShip=index;
      ship=ships[currentShip]; ship.visible=true;
      updateShipPopup();
      shipPopup.style.display='none';
    });
    shipList.appendChild(div);
  });
}

btnShipPopup.addEventListener('click',()=>{
  updateShipPopup();
  shipPopup.style.display='block';
});

function createRoundSprite(){
  const size=64,canvas=document.createElement('canvas'),ctx=canvas.getContext('2d');
  canvas.width=canvas.height=size;
  const grd=ctx.createRadialGradient(size/2,size/2,2,size/2,size/2,size/2);
  grd.addColorStop(0,'rgba(255,255,255,1)');grd.addColorStop(0.2,'rgba(160,200,255,1)');
  grd.addColorStop(0.4,'rgba(120,182,255,1)');grd.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=grd;ctx.fillRect(0,0,size,size);
  const tex=new THREE.CanvasTexture(canvas); tex.minFilter=THREE.LinearFilter; return tex;
}
const starSprite=createRoundSprite();

// --- Champs d'étoiles et poussière ---
(function makeStars(){
  const layers=[{count:800,radiusMin:800,radiusMax:3000,size:14,twinkle:0.0002},{count:400,radiusMin:300,radiusMax:1400,size:10,twinkle:0.0004}];
  window._starFields=[];
  for(const L of layers){
    const geom=new THREE.BufferGeometry();
    const positions=new Float32Array(L.count*3);
    const sizes=new Float32Array(L.count);
    for(let i=0;i<L.count;i++){
      const r=L.radiusMin+Math.random()*(L.radiusMax-L.radiusMin);
      const theta=Math.random()*Math.PI*2;
      const phi=(Math.random()-0.5)*Math.PI;
      positions[i*3]=Math.cos(theta)*Math.cos(phi)*r;
      positions[i*3+1]=Math.sin(phi)*r;
      positions[i*3+2]=Math.sin(theta)*Math.cos(phi)*r;
      sizes[i]=L.size*(0.7+Math.random()*0.6);
    }
    geom.setAttribute('position', new THREE.BufferAttribute(positions,3));
    geom.setAttribute('size', new THREE.BufferAttribute(sizes,1));
    const mat=new THREE.PointsMaterial({map:starSprite,size:L.size,transparent:true,opacity:0.85,depthWrite:false,blending:THREE.AdditiveBlending});
    const points=new THREE.Points(geom,mat); scene.add(points);
    window._starFields.push({points,mat,twinkle:L.twinkle});
  }
})();
(function makeDust(){
  const count=1500,geom=new THREE.BufferGeometry(),pos=new Float32Array(count*3);
  for(let i=0;i<count;i++){
    const r=50+Math.random()*2500,theta=Math.random()*Math.PI*2,phi=(Math.random()-0.5)*Math.PI;
    pos[i*3]=Math.cos(theta)*Math.cos(phi)*r;
    pos[i*3+1]=Math.sin(phi)*r*0.2;
    pos[i*3+2]=Math.sin(theta)*Math.cos(phi)*r;
  }
  geom.setAttribute('position',new THREE.BufferAttribute(pos,3));
  const pts=new THREE.Points(geom,new THREE.PointsMaterial({size:1.2,transparent:true,opacity:0.12,depthWrite:false,blending:THREE.AdditiveBlending,color:0xfff7ef}));
  scene.add(pts);
  window._dust={pts};
})();

// --- Planètes ---
function makePlanet(name,radius,distance,texture,opts={}){
  const geom=new THREE.SphereGeometry(radius,opts.segments||32,opts.segments||32);
  const matOptions={metalness:0.02,roughness:0.7};
  if(texture) matOptions.map=texture; else matOptions.color=opts.color||0x999999;
  const mesh=new THREE.Mesh(geom,new THREE.MeshStandardMaterial(matOptions));
  mesh.position.set(distance,0,0);
  mesh.userData={name,distance,orbitalSpeed:(opts.orbitalPeriod?1/opts.orbitalPeriod:0.00005+Math.random()*0.0001)*0.4,rotationSpeed:opts.rotationSpeed||0.0005};
  if(opts.ring){
    const ringGeo=new THREE.RingGeometry(opts.ring.inner||radius*1.2,opts.ring.outer||radius*2.0,128);
    const ringMat=new THREE.MeshBasicMaterial({map:opts.ring.map||null,side:THREE.DoubleSide,transparent:true,opacity:0.9});
    const ring=new THREE.Mesh(ringGeo,ringMat); ring.rotation.x=Math.PI/2.2; ring.position.copy(mesh.position); scene.add(ring); mesh.userData.ring=ring;
  }
  scene.add(mesh); return mesh;
}

const planets=[];
planets.push(makePlanet('Mercure',4,70,mercuryTex,{orbitalPeriod:88,rotationSpeed:0.0008}));
planets.push(makePlanet('Vénus',6.8,90,venusTex,{orbitalPeriod:225,rotationSpeed:0.0002}));
const earth=makePlanet('Terre',9.7,120,earthTex,{orbitalPeriod:365,rotationSpeed:0.001}); planets.push(earth);
if(earthCloudsTex){ const clouds=new THREE.Mesh(new THREE.SphereGeometry(2.06,32,32),new THREE.MeshPhongMaterial({map:earthCloudsTex,transparent:true,opacity:0.9,depthWrite:false})); earth.add(clouds);}
const moon=new THREE.Mesh(new THREE.SphereGeometry(0.54,24,24),new THREE.MeshStandardMaterial({map:moonTex}));
moon.position.set(4.5,0,0); earth.add(moon); moon.userData={orbitSpeed:0.01,distance:4.5,angle:0};
planets.push(makePlanet('Mars',6.1,261,marsTex,{orbitalPeriod:687,rotationSpeed:0.001}));
planets.push(makePlanet('Jupiter',5.5,185,jupiterTex,{orbitalPeriod:4333,rotationSpeed:0.002}));
planets.push(makePlanet('Saturne',9.8,212,saturnTex,{orbitalPeriod:10759,rotationSpeed:0.0015,ring:{inner:6,outer:9,map:saturnRingTex}}));
planets.push(makePlanet('Uranus',4,327,uranusTex,{orbitalPeriod:30687,rotationSpeed:0.0008}));
planets.push(makePlanet('Neptune',2.9,352,neptuneTex,{orbitalPeriod:60190,rotationSpeed:0.0009}));
const pluto=makePlanet('Pluton',9.6,300,null,{orbitalPeriod:90560,rotationSpeed:0.0004}); pluto.material.color.set(0x9b7b6a); planets.push(pluto);

const ORBIT_SPEED_FACTOR=0.2;

// --- Vaisseaux ---
let ships=[],currentShip=0,ship;
function createShip(type){
    const g=new THREE.Group();
    if(type==='classic'){
        const bodyMat=new THREE.MeshStandardMaterial({color:0x8a8f92,metalness:0.85,roughness:0.2});
        const body=new THREE.Mesh(new THREE.ConeGeometry(0.6,2.2,24),bodyMat); body.rotation.x=Math.PI/2; g.add(body);
        const glass=new THREE.Mesh(new THREE.SphereGeometry(0.42,18,18),new THREE.MeshPhysicalMaterial({color:0x222831,transmission:0.6,transparent:true,opacity:0.95,roughness:0.1}));
        glass.position.set(0,0.45,0.6); g.add(glass);
        const wingL=new THREE.Mesh(new THREE.BoxGeometry(0.12,0.5,1.2),bodyMat); wingL.position.set(-0.9,0,-0.2); wingL.rotation.z=0.06;
        const wingR=wingL.clone(); wingR.position.set(0.9,0,-0.2); g.add(wingL,wingR);
    } else if(type==='sleek'){
        const mat=new THREE.MeshStandardMaterial({color:0x2222ff,metalness:0.9,roughness:0.1});
        const body=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.6,3,20),mat); body.rotation.x=Math.PI/2; g.add(body);
        const fin=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.5,1.5),mat); fin.position.set(0,-0.6,0); fin.rotation.x=0.2; g.add(fin);
    } else if(type==='bulky'){
        const mat=new THREE.MeshStandardMaterial({color:0xff2222,metalness:0.7,roughness:0.3});
        const body=new THREE.Mesh(new THREE.BoxGeometry(1.2,0.6,2.5),mat); g.add(body);
        const thruster=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,0.6,12),mat); thruster.position.set(0,-0.4,-1.5); g.add(thruster);
    }
    g.userData={type};
    g.visible=false;
    return g;
}
ships.push(createShip('classic')); ships.push(createShip('sleek')); ships.push(createShip('bulky'));
ships[0].visible=true; ship=ships[0]; ship.position.set(28,6,12); scene.add(ship);
document.getElementById('btnShip').addEventListener('click',()=>{
    ships[currentShip].visible=false;
    currentShip=(currentShip+1)%ships.length;
    if(currentShip>0 && !challenges[3].done) currentShip=0;
    if(currentShip>1 && !challenges[4].done) currentShip=1;
    ship=ships[currentShip]; ship.visible=true;
});

// --- Défis ---
const challenges=[
  {name:"Parcourir 1000 km",target:1000,progress:0,done:false},
  {name:"Visiter 3 planètes",target:3,progress:0,done:false},
  {name:"Entrer dans 2 galaxies",target:2,progress:0,done:false},
  {name:"Débloquer vaisseau Sleek",target:1,progress:0,done:false},
  {name:"Débloquer vaisseau Bulky",target:2,progress:0,done:false}
];
const challengeListEl=document.getElementById('challengeList'),challengePopup=document.getElementById('challengePopup'),notifEl=document.getElementById('challengeNotif');
function updateChallengesUI(){challengeListEl.innerHTML=''; challenges.forEach(c=>{const div=document.createElement('div');div.innerHTML=`<b>${c.name}</b> <span>${Math.min(c.progress,c.target)}/${c.target}</span><div class="progressBar"><div class="progressFill" style="width:${(c.progress/c.target)*100}%"></div></div>`; challengeListEl.appendChild(div);});}
function showNotif(text){notifEl.textContent=text;notifEl.style.opacity='1'; setTimeout(()=>{notifEl.style.opacity='0';},2500);}
document.getElementById('btnChallenge').addEventListener('click',()=>{updateChallengesUI(); challengePopup.style.display='block';});
document.getElementById('closeChallenge').addEventListener('click',()=>challengePopup.style.display='none');
document.getElementById('btnInfo').addEventListener('click',()=>document.getElementById('infoPopup').style.display='block');
document.getElementById('closeInfo').addEventListener('click',()=>document.getElementById('infoPopup').style.display='none');

// --- Galaxies et gemmes ---
const galaxies=[
  {name:'Milky Way',offset:new THREE.Vector3(0,0,0),gems:[]},
  {name:'Andromeda',offset:new THREE.Vector3(5000,0,0),gems:[]},
  {name:'Triangulum',offset:new THREE.Vector3(-5000,0,0),gems:[]}
];
let currentGalaxy=0;
function spawnGems(galaxy){
  for(let i=0;i<2;i++){
    const g=new THREE.Mesh(new THREE.SphereGeometry(1,12,12),new THREE.MeshBasicMaterial({map:gemTex,transparent:true}));
    g.position.set(galaxy.offset.x+Math.random()*500-250, Math.random()*100, galaxy.offset.z+Math.random()*500-250);
    g.userData.collected=false;
    scene.add(g); galaxy.gems.push(g);
  }
}
galaxies.forEach(g=>spawnGems(g));

// --- Contrôle et physique ---
let move={x:0,y:0,up:false,down:false};
const joy=document.getElementById('joystick'),joyInner=document.getElementById('joyInner');
joy.addEventListener('touchstart',e=>e.preventDefault());
joy.addEventListener('touchmove',e=>{
  const t=e.touches[0],r=joy.getBoundingClientRect();
  move.x=Math.max(-1,Math.min(1,(t.clientX-(r.left+r.width/2))/(r.width/2)));
  move.y=Math.max(-1,Math.min(1,-(t.clientY-(r.top+r.height/2))/(r.height/2)));
  joyInner.style.transform=`translate(${move.x*25}px, ${-move.y*25}px)`;
});
joy.addEventListener('touchend',()=>{move.x=0;move.y=0;joyInner.style.transform='translate(0,0)';});
document.getElementById('btnUp').addEventListener('touchstart',()=>move.up=true);
document.getElementById('btnUp').addEventListener('touchend',()=>move.up=false);
document.getElementById('btnDown').addEventListener('touchstart',()=>move.down=true);
document.getElementById('btnDown').addEventListener('touchend',()=>move.down=false);

let velocity=new THREE.Vector3(),direction=new THREE.Vector3();
const forwardVec=new THREE.Vector3(0,0,-1);
planets.forEach(p=>{p.userData.angle=Math.random()*Math.PI*2;}); moon.userData.angle=0;

// --- Animation ---
let totalDistance=0;
const lastPos=new THREE.Vector3().copy(ship.position);
function updateChallengeProgress(){
  const dist=lastPos.distanceTo(ship.position); totalDistance+=dist; lastPos.copy(ship.position);
  const d1=challenges[0]; if(!d1.done){d1.progress=totalDistance; if(d1.progress>=d1.target){d1.done=true; showNotif(`Défi terminé: ${d1.name}`);}}
  // Collecter gemmes
  galaxies.forEach(g=>g.gems.forEach(gem=>{
    if(!gem.userData.collected && ship.position.distanceTo(gem.position)<3){gem.userData.collected=true; scene.remove(gem);
      if(challenges[3].progress<1) challenges[3].progress=1; else if(challenges[4].progress<2) challenges[4].progress=2;
      showNotif("Gemme collectée!");
    }
  }));
  updateChallengesUI();
}

function animate(){
  requestAnimationFrame(animate);
  const now=Date.now();
  planets.forEach(p=>{p.userData.angle+=p.userData.orbitalSpeed*ORBIT_SPEED_FACTOR; const a=p.userData.angle,d=p.userData.distance; p.position.x=Math.cos(a)*d; p.position.z=Math.sin(a)*d; if(p.userData.ring)p.userData.ring.position.copy(p.position); p.rotation.y+=(p.userData.rotationSpeed||0.0005);});
  moon.userData.angle+=0.002; moon.position.x=Math.cos(moon.userData.angle)*moon.userData.distance; moon.position.z=Math.sin(moon.userData.angle)*moon.userData.distance;
  if(window._starFields)window._starFields.forEach((sf,i)=>{sf.mat.opacity=0.75+0.15*Math.sin(now*sf.twinkle*(i+1));});
  if(window._dust&&window._dust.pts)window._dust.pts.rotation.y+=0.00001;

  direction.set(0,0,0); const localF=forwardVec.clone().applyEuler(ship.rotation); direction.add(localF.multiplyScalar(move.y*0.45));
  if(move.up)direction.y+=0.12; if(move.down)direction.y-=0.12; velocity.lerp(direction,0.06); ship.position.add(velocity);
  ship.rotation.x=0; ship.rotation.z=0; ship.rotation.y-=move.x*0.04;

  const desired=ship.position.clone().add(new THREE.Vector3(0,2,8).applyEuler(ship.rotation)); camera.position.lerp(desired,0.08); camera.lookAt(ship.position);
  renderer.render(scene,camera);

  updateChallengeProgress();
}
animate();
window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight);});
</script>
</body>
</html>
