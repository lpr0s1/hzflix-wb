<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>SpaceGame — Galaxies et Trous de Ver</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<style>
html,body{margin:0;height:100%;background:#000;user-select:none}
canvas{display:block}
#loader{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-family:system-ui,Arial;z-index:10}
.joystick{position:fixed;left:16px;bottom:16px;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,0.06);touch-action:none}
.joystick-inner{width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,0.18);position:relative;left:25px;top:25px;pointer-events:none}
.btn{position:fixed;right:16px;width:60px;height:60px;border-radius:50%;background:rgba(255,255,255,0.08);text-align:center;line-height:60px;color:#fff}
.btn.up{bottom:96px}.btn.down{bottom:16px}
#galaxyLabel{position:fixed;left:50%;transform:translateX(-50%);top:16px;color:#fff;padding:8px 12px;background:rgba(0,0,0,0.35);border-radius:8px;font-family:system-ui,Arial;z-index:9}
</style>
</head>
<body>
<div id="loader">Chargement...</div>
<div id="galaxyLabel">Galaxie 1</div>
<div class="joystick" id="joystick"><div class="joystick-inner" id="joyInner"></div></div>
<div class="btn up" id="btnUp">↑</div>
<div class="btn down" id="btnDown">↓</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';

const loaderEl = document.getElementById('loader');
const galaxyLabel = document.getElementById('galaxyLabel');

const texLoader = new THREE.TextureLoader();
async function loadSafe(url){
  return new Promise(resolve=>{
    texLoader.load(url, tex=>resolve(tex), undefined, ()=>resolve(null));
  });
}

const texMap = {
  mercury: 'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/mercury.jpg',
  venus:   'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/venus.jpg',
  earth:   'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/earth_atmos_2048.jpg',
  earthClouds: 'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/earth_clouds_1024.png',
  moon:    'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/moon_1024.jpg',
  mars:    'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/mars_1k_color.jpg',
  jupiter: 'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/jupiter.jpg',
  saturn:  'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/saturn.jpg',
  saturnRing: 'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/saturnringcolor.jpg',
  uranus:  'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/uranus.jpg',
  neptune:'https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/planets/neptune.jpg'
};

const [
  mercuryTex, venusTex, earthTex, earthCloudsTex, moonTex,
  marsTex, jupiterTex, saturnTex, saturnRingTex, uranusTex, neptuneTex
] = await Promise.all([
  loadSafe(texMap.mercury), loadSafe(texMap.venus), loadSafe(texMap.earth),
  loadSafe(texMap.earthClouds), loadSafe(texMap.moon), loadSafe(texMap.mars),
  loadSafe(texMap.jupiter), loadSafe(texMap.saturn), loadSafe(texMap.saturnRing),
  loadSafe(texMap.uranus), loadSafe(texMap.neptune)
]);

loaderEl.style.display='none';

// --- SCENE, CAMERA, RENDERER ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000010);
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100000);
camera.position.set(0,40,120);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio||1,2));
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

// LIGHTS
scene.add(new THREE.AmbientLight(0x666666));
const sunLight = new THREE.PointLight(0xffffff,1.6,0); sunLight.position.set(0,0,0); scene.add(sunLight);

// TEXTURE STAR SPRITE
function createRoundSprite(){
  const size = 64;
  const canvas = document.createElement('canvas');
  canvas.width = canvas.height = size;
  const ctx = canvas.getContext('2d');
  const grd = ctx.createRadialGradient(size/2,size/2,2,size/2,size/2,size/2);
  grd.addColorStop(0,'rgba(255,255,255,1)');
  grd.addColorStop(0.2,'rgba(160,200,255,0.9)');
  grd.addColorStop(0.4,'rgba(120,160,255,0.6)');
  grd.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle = grd;
  ctx.fillRect(0,0,size,size);
  const tex = new THREE.CanvasTexture(canvas);
  tex.minFilter = THREE.LinearFilter;
  return tex;
}
const starSprite = createRoundSprite();

// STARFIELDS
function makeStars(count, radiusMin, radiusMax, size, opacity){
  const geom = new THREE.BufferGeometry();
  const pos = new Float32Array(count*3);
  for(let i=0;i<count;i++){
    const r = radiusMin + Math.random()*(radiusMax-radiusMin);
    const theta = Math.random()*Math.PI*2;
    const phi = (Math.random()-0.5)*Math.PI;
    pos[i*3] = Math.cos(theta)*Math.cos(phi)*r;
    pos[i*3+1] = Math.sin(phi)*r;
    pos[i*3+2] = Math.sin(theta)*Math.cos(phi)*r;
  }
  geom.setAttribute('position', new THREE.BufferAttribute(pos,3));
  const mat = new THREE.PointsMaterial({map:starSprite, size:size, transparent:true, opacity:opacity, depthWrite:false, blending:THREE.AdditiveBlending});
  return new THREE.Points(geom, mat);
}

// --- GALAXIE 1 ---
const galaxy1 = {planets:[], wormholes:[], blackholes:[], stars:makeStars(1500,800,3000,6,0.9)};
scene.add(galaxy1.stars);

// Planet factory
function makePlanet(radius, distance, texture, options={}){
  const geom = new THREE.SphereGeometry(radius,32,32);
  const matOpts = {metalness:0.02, roughness:0.7};
  if(texture) matOpts.map=texture; else matOpts.color=options.color||0x999999;
  const mesh = new THREE.Mesh(geom, new THREE.MeshStandardMaterial(matOpts));
  mesh.position.set(distance,0,0);
  mesh.userData = {orbitalSpeed:options.orbitalSpeed||0.00005, rotationSpeed:options.rotationSpeed||0.0005};
  scene.add(mesh);
  return mesh;
}

// Galaxie 1 Planètes x30
galaxy1.planets.push(makePlanet(3*30,50,mercuryTex,{orbitalSpeed:0.0001}));
galaxy1.planets.push(makePlanet(5*30,80,venusTex,{orbitalSpeed:0.00005}));
const earth1 = makePlanet(6*30,120,earthTex,{orbitalSpeed:0.00008});
galaxy1.planets.push(earth1);
const moon1 = new THREE.Mesh(new THREE.SphereGeometry(1.2*17,24,24), new THREE.MeshStandardMaterial({map:moonTex}));
moon1.position.set(12*20,0,0);
earth1.add(moon1);
galaxy1.planets.push(makePlanet(4*14,170,marsTex,{orbitalSpeed:0.00006}));
galaxy1.planets.push(makePlanet(16*14,260,jupiterTex,{orbitalSpeed:0.00002}));
galaxy1.planets.push(makePlanet(14*14,350,saturnTex,{orbitalSpeed:0.000015}));
galaxy1.planets.push(makePlanet(9*14,450,uranusTex,{orbitalSpeed:0.000008}));
galaxy1.planets.push(makePlanet(9*14,550,neptuneTex,{orbitalSpeed:0.000009}));

// --- GALAXIE 2 (différentes planètes) ---
const galaxy2 = {planets:[], wormholes:[], blackholes:[], stars:makeStars(1500,800,3000,6,0.9)};
scene.add(galaxy2.stars);
galaxy2.stars.visible=false;

// Galaxie 2 Planètes différentes
galaxy2.planets.push(makePlanet(20*14,60,null,{orbitalSpeed:0.00007}));
galaxy2.planets.push(makePlanet(18*16,130,null,{orbitalSpeed:0.00004}));
galaxy2.planets.push(makePlanet(22*15,210,null,{orbitalSpeed:0.00002}));
galaxy2.planets.push(makePlanet(15*15,300,null,{orbitalSpeed:0.00003}));

// --- TROUS DE VER ET TROUS NOIRS ---
function makeWormhole(pos){ // sphère avec effet shader/mesh simple
  const geo = new THREE.TorusGeometry(20,5,27,64);
  const mat = new THREE.MeshBasicMaterial({color:0x66ccff, transparent:true, opacity:0.7});
  const mesh = new THREE.Mesh(geo, mat);
  mesh.position.copy(pos);
  scene.add(mesh);
  return mesh;
}
function makeBlackHole(pos){
  const geo = new THREE.SphereGeometry(20,22,22);
  const mat = new THREE.MeshBasicMaterial({color:0x000000});
  const mesh = new THREE.Mesh(geo, mat);
  mesh.position.copy(pos);
  scene.add(mesh);
  return mesh;
}

// Galaxie 1 Wormholes
galaxy1.wormholes.push(makeWormhole(new THREE.Vector3(400,0,0)));
galaxy1.wormholes.push(makeWormhole(new THREE.Vector3(-400,0,0)));
// Galaxie 1 Blackholes
galaxy1.blackholes.push(makeBlackHole(new THREE.Vector3(0,0,400)));
galaxy1.blackholes.push(makeBlackHole(new THREE.Vector3(0,0,-400)));

// Galaxie 2 Wormholes (retour)
galaxy2.wormholes.push(makeWormhole(new THREE.Vector3(400,0,0)));
galaxy2.wormholes.push(makeWormhole(new THREE.Vector3(-400,0,0)));
// Galaxie 2 Blackholes
galaxy2.blackholes.push(makeBlackHole(new THREE.Vector3(0,0,400)));
galaxy2.blackholes.push(makeBlackHole(new THREE.Vector3(0,0,-400)));

// ---------------- Vaisseau Star-Lord style ----------------
function assembleStarLordShip(){
  const g = new THREE.Group();
  const bodyMat = new THREE.MeshStandardMaterial({color:0x999999, metalness:0.8, roughness:0.3});
  const body = new THREE.Mesh(new THREE.BoxGeometry(3,0.4,5),bodyMat); g.add(body);
  const cockpit = new THREE.Mesh(new THREE.SphereGeometry(0.8,16,16), new THREE.MeshPhysicalMaterial({color:0x111111, transmission:0.7, transparent:true, opacity:0.95}));
  cockpit.position.set(0,0.35,1.5); g.add(cockpit);
  // Ailes triangulaires
  const wingMat = new THREE.MeshStandardMaterial({color:0xff5500, metalness:0.8});
  const wingL = new THREE.Mesh(new THREE.ConeGeometry(1.2,3,3), wingMat); wingL.rotation.set(Math.PI/2,0,Math.PI/6); wingL.position.set(-2,0,-1); g.add(wingL);
  const wingR = wingL.clone(); wingR.position.set(2,0,-1); wingR.rotation.z = -Math.PI/6; g.add(wingR);
  // Turbo
  const turboMat = new THREE.MeshStandardMaterial({color:0x333333});
  const tL = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,0.6,16),turboMat); tL.rotation.x=Math.PI/2; tL.position.set(-1,-0.2,-2.5); g.add(tL);
  const tR = tL.clone(); tR.position.set(1,-0.2,-2.5); g.add(tR);
  // Exhaust
  const exhaustGeom = new THREE.BufferGeometry();
  const count=200; const arr=new Float32Array(count*3);
  for(let i=0;i<count;i++){arr[i*3]=(Math.random()-0.5)*0.5;arr[i*3+1]=-0.2-Math.random()*0.3;arr[i*3+2]=-2.5-Math.random()*0.6;}
  exhaustGeom.setAttribute('position', new THREE.BufferAttribute(arr,3));
  const exhaustMat = new THREE.PointsMaterial({color:0xffaa66,size:0.2,transparent:true,opacity:0.85});
  const exhaust = new THREE.Points(exhaustGeom, exhaustMat); g.add(exhaust);
  g.userData={updateExhaust:()=>{const a=exhaustGeom.attributes.position.array;for(let i=0;i<count;i++){const idx=i*3;a[idx]+=(Math.random()-0.5)*0.01;a[idx+1]-=0.01;a[idx+2]+=(Math.random()-0.5)*0.01;if(a[idx+1]<-1) a[idx+1]=-0.2-Math.random()*0.2;}exhaustGeom.attributes.position.needsUpdate=true}};
  return g;
}

let ship = assembleStarLordShip();
ship.position.set(130,15,30);
scene.add(ship);

let move={x:0,y:0,up:false,down:false};
const joy=document.getElementById('joystick'), joyInner=document.getElementById('joyInner');
joy.addEventListener('touchstart',e=>e.preventDefault());
joy.addEventListener('touchmove',e=>{
  const t=e.touches[0]; const r=joy.getBoundingClientRect();
  move.x=Math.max(-1,Math.min(1,(t.clientX-(r.left+r.width/2))/(r.width/2)));
  move.y=Math.max(-1,Math.min(1,-(t.clientY-(r.top+r.height/2))/(r.height/2)));
  joyInner.style.transform=`translate(${move.x*25}px, ${-move.y*25}px)`;
});
joy.addEventListener('touchend',()=>{move.x=0;move.y=0;joyInner.style.transform='translate(0,0)';});
document.getElementById('btnUp').addEventListener('touchstart',()=>move.up=true);
document.getElementById('btnUp').addEventListener('touchend',()=>move.up=false);
document.getElementById('btnDown').addEventListener('touchstart',()=>move.down=true);
document.getElementById('btnDown').addEventListener('touchend',()=>move.down=false);

// --- ANIMATION LOOP ---
let velocity=new THREE.Vector3(), direction=new THREE.Vector3();
const forwardVec = new THREE.Vector3(0,0,-1);
let currentGalaxy = 1;
function getCurrentGal(){
  return currentGalaxy===1?galaxy1:galaxy2;
}

// Collision planétaire
function checkCollision(){
  const gal = getCurrentGal();
  for(const p of gal.planets){
    const dist = ship.position.distanceTo(p.position);
    if(dist < p.geometry.parameters.radius + 2){
      const dir = ship.position.clone().sub(p.position).normalize();
      ship.position.copy(p.position.clone().add(dir.multiplyScalar(p.geometry.parameters.radius + 2)));
      velocity.set(0,0,0);
    }
  }
}

// Vérifie trous de ver
function checkWormholes(){
  const gal = getCurrentGal();
  for(const wh of gal.wormholes){
    const d = ship.position.distanceTo(wh.position);
    if(d<20){
      // Distorsion visuelle: scale temporaire des étoiles
      gal.stars.scale.set(1.5,1.5,1.5);
      // Aspire le vaisseau
      velocity.z -= 0.5;
      // Téléportation après distance
      if(d<1){
        currentGalaxy = currentGalaxy===1?2:1;
        const newGal = getCurrentGal();
        ship.position.copy(new THREE.Vector3(0,10,30));
        galaxyLabel.textContent = `Galaxie ${currentGalaxy}`;
        gal.stars.scale.set(1,1,1);
      }
    }
  }
}

const ORBIT_SPEED_FACTOR = 0.7;

function animate(){
  requestAnimationFrame(animate);
  const now = Date.now();

  // Orbits
  for(const gal of [galaxy1, galaxy2]){
    for(const p of gal.planets){
      if(!p.userData.angle) p.userData.angle=Math.random()*Math.PI*2;
      p.userData.angle += p.userData.orbitalSpeed*ORBIT_SPEED_FACTOR;
      const a = p.userData.angle; const d = p.position.length();
      p.position.x = Math.cos(a)*d; p.position.z = Math.sin(a)*d;
      p.rotation.y += p.userData.rotationSpeed;
    }
  }

  ship.userData.updateExhaust && ship.userData.updateExhaust();

  direction.set(0,0,0);
  const localF = forwardVec.clone().applyEuler(ship.rotation);
  direction.add(localF.multiplyScalar(move.y*1.2));
  if(move.up) direction.y += 0.4;
  if(move.down) direction.y -= 0.4;
  velocity.lerp(direction,0.06);
  ship.position.add(velocity);
  ship.rotation.y -= move.x*0.04;

  checkCollision();
  checkWormholes();

  // Camera
  const desired = ship.position.clone().add(new THREE.Vector3(0,30,60).applyEuler(ship.rotation));
  camera.position.lerp(desired,0.08);
  camera.lookAt(ship.position);

  // Affiche uniquement étoiles de la galaxie actuelle
  galaxy1.stars.visible = currentGalaxy===1;
  galaxy2.stars.visible = currentGalaxy===2;

  renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', ()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});
window.addEventListener('keydown',(e)=>{
  if(e.key.toLowerCase()==='g'){ ship.position.set(0,0,0); velocity.set(0,0,0);}
  if(e.key.toLowerCase()==='h'){ ship.position.set(130,15,30); velocity.set(0,0,0);}
});

</script>
</body>
</html>
