<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Risque de Contrôle</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-red-500 min-h-screen flex flex-col items-center justify-start p-4 space-y-6">
  <div class="w-full max-w-2xl text-center">
    <select id="citySelect" class="text-black p-2 rounded mb-4">
      <option value="lille">Lille</option>
      <option value="valenciennes">Valenciennes</option>
      <option value="dunkerque">Dunkerque</option>
      <option value="arras">Arras</option>
      <option value="roubaix">Roubaix</option>
    </select>
    <h1 class="text-4xl font-bold">Risque de Contrôle</h1>
    <p id="riskPercent" class="text-7xl mt-4">Chargement...</p>
    <p id="dateTime" class="text-sm text-gray-300 mt-2"></p>
    <p id="riskDescription" class="text-xl mt-4"></p>
    <div id="sources" class="mt-6 text-left"></div>
  </div>

  <script>
    const sites = {
      lille: [
        {url:'https://www.lavoixdunord.fr/region/lille-et-environs', conf:90},
        {url:'https://www.francebleu.fr/infos/faits-divers-justice', conf:85},
        {url:'https://twitter.com/PoliceNat59', conf:70},
        {url:'https://www.bison-fute.gouv.fr/index.html', conf:93},
        {url:'https://www.radars-auto.com/', conf:88}
      ],
      valenciennes: [
        {url:'https://www.lavoixdunord.fr/region/valenciennes-et-environs', conf:90},
        {url:'https://www.francebleu.fr/infos/faits-divers-justice', conf:85},
        {url:'https://www.radars-auto.com/', conf:88},
        {url:'https://www.bison-fute.gouv.fr/index.html', conf:93},
        {url:'https://twitter.com/Prefet59', conf:75}
      ],
      dunkerque: [
        {url:'https://www.lavoixdunord.fr/region/dunkerque-et-environs', conf:90},
        {url:'https://www.francebleu.fr/infos/faits-divers-justice', conf:85},
        {url:'https://www.radars-auto.com/', conf:88},
        {url:'https://www.bison-fute.gouv.fr/index.html', conf:93},
        {url:'https://twitter.com/Prefet59', conf:75}
      ],
      arras: [
        {url:'https://www.lavoixdunord.fr/region/arras-et-environs', conf:90},
        {url:'https://www.francebleu.fr/infos/faits-divers-justice', conf:85},
        {url:'https://www.radars-auto.com/', conf:88},
        {url:'https://www.bison-fute.gouv.fr/index.html', conf:93},
        {url:'https://twitter.com/Prefet59', conf:75}
      ],
      roubaix: [
        {url:'https://www.lavoixdunord.fr/region/roubaix-et-environs', conf:90},
        {url:'https://www.francebleu.fr/infos/faits-divers-justice', conf:85},
        {url:'https://www.radars-auto.com/', conf:88},
        {url:'https://www.bison-fute.gouv.fr/index.html', conf:93},
        {url:'https://twitter.com/PoliceNat59', conf:70}
      ]
    };

    const motsCles = ['contrôle', 'police', 'barrage', 'radar', 'filtrage', 'sécurité routière', 'opération de contrôle', 'alcoolémie', 'intervention', 'contrôle routier', 'vérifications', 'opération anti-drogue'];

    async function scrapSites() {
      const city = document.getElementById('citySelect').value;
      let totalScore = 0;
      let sourcesHTML = '';
      for (let site of sites[city]) {
        try {
          const response = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(site.url));
          const text = await response.text();
          let match = false;
          for (let mot of motsCles) {
            if (text.toLowerCase().includes(mot) && text.toLowerCase().includes(city)) {
              match = true;
              break;
            }
          }
          if (match) {
            totalScore += site.conf / 5;
            sourcesHTML += `<div class="mt-2">✅ ${site.url} (+${Math.round(site.conf / 5)}%)</div>`;
          } else {
            sourcesHTML += `<div class="mt-2 text-gray-500">❌ ${site.url}</div>`;
          }
        } catch (e) {
          sourcesHTML += `<div class="mt-2 text-gray-500">❌ ${site.url} (Erreur d'accès)</div>`;
        }
      }
      const now = new Date();
      const heure = now.getHours();
      if (heure >= 7 && heure <= 9) totalScore += 5;
      if (heure >= 16 && heure <= 19) totalScore += 5;
      if (heure >= 22 || heure <= 4) totalScore += 10;
      const jour = now.getDay();
      if (jour === 5 || jour === 6) totalScore += 10;
      totalScore += 20;
      if (totalScore > 100) totalScore = 100;
      document.getElementById('riskPercent').innerText = Math.round(totalScore) + '%';
      document.getElementById('dateTime').innerText = `Mise à jour: ${now.toLocaleString()}`;
      document.getElementById('riskDescription').innerText = getRiskDescription(totalScore);
      document.getElementById('sources').innerHTML = sourcesHTML;
    }

    function getRiskDescription(score) {
      if (score < 20) return 'Pas d\'inquiétude';
      if (score < 50) return 'Peu probable';
      if (score < 80) return 'Fort probable';
      return 'Risque très élevé';
    }

    document.getElementById('citySelect').addEventListener('change', () => {
      scrapSites();
    });

    scrapSites();
    setInterval(scrapSites, 60000);
  </script>
</body>
</html>
