<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Risque de Contrôle en Temps Réel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-6">
  <div class="bg-white rounded-lg shadow-md p-6 w-full max-w-3xl text-center">
    <h1 class="text-4xl font-bold mb-6">Contrôles Police - Temps Réel</h1>
    <div class="mb-4">
      <label for="city" class="block text-xl font-semibold mb-2">Choisis ta ville :</label>
      <select id="city" class="border border-gray-400 rounded p-2 w-full text-lg">
        <option value="lille">Lille</option>
        <option value="valenciennes">Valenciennes</option>
        <option value="douai">Douai</option>
        <option value="arras">Arras</option>
        <option value="lens">Lens</option>
      </select>
    </div>
    <p id="status" class="text-gray-700 text-xl mb-4">Chargement...</p>
    <div id="risk" class="text-8xl font-bold text-blue-600 mb-6"></div>
    <div id="sources" class="text-left mt-6">
      <h2 class="text-2xl font-bold mb-2">Sources :</h2>
      <ul id="sourcesList" class="list-disc list-inside text-gray-700"></ul>
    </div>
  </div>

<script>
const sources = [
  { name: "Radarbot", url: "https://corsproxy.io/?https://www.radarbot.net/fr/reportes-en-directo/" },
  { name: "TomTom Traffic", url: "https://corsproxy.io/?https://www.tomtom.com/fr_fr/trafic/" },
  { name: "Waze Live Map", url: "https://corsproxy.io/?https://www.waze.com/live-map" },
  { name: "InfoTrafic Nord", url: "https://corsproxy.io/?https://www.infotrafic.com/" },
  { name: "France Bleu Nord", url: "https://corsproxy.io/?https://www.francebleu.fr/nord" },
  { name: "France 3 Hauts-de-France", url: "https://corsproxy.io/?https://france3-regions.francetvinfo.fr/hauts-de-france/nord-0" },
  { name: "La Voix du Nord", url: "https://corsproxy.io/?https://www.lavoixdunord.fr/" },
  { name: "Twitter Lille", url: "https://corsproxy.io/?https://twitter.com/search?q=controle%20police%20lille" },
  { name: "Twitter Valenciennes", url: "https://corsproxy.io/?https://twitter.com/search?q=controle%20police%20valenciennes" },
  { name: "Google News Lille", url: "https://corsproxy.io/?https://news.google.com/search?q=contrôle%20police%20lille" },
  // Ajoute encore 20+ si tu veux après
];

const keywords = ["contrôle", "police", "radar", "gendarmerie", "CRS", "alcoolémie", "radar mobile", "patrouille"];
const baseRiskJeunePermis = 20; // 20% de base pour ton profil
const cityMapping = {
  lille: ["lille", "hauts-de-france"],
  valenciennes: ["valenciennes", "nord"],
  douai: ["douai", "nord"],
  arras: ["arras", "pas-de-calais"],
  lens: ["lens", "pas-de-calais"]
};

async function fetchData(url) {
  try {
    const response = await axios.get(url);
    return response.data;
  } catch (error) {
    console.error(`Erreur en récupérant ${url}`);
    return null;
  }
}

async function analyzeCity(city) {
  document.getElementById('status').innerText = "Analyse en cours...";
  document.getElementById('risk').innerText = "...";
  document.getElementById('sourcesList').innerHTML = "";

  let totalScore = 0;
  const detectedSources = [];
  const cityKeywords = cityMapping[city];

  const fetches = sources.map(async (source) => {
    const html = await fetchData(source.url);
    if (!html) return;

    const lowerHTML = html.toLowerCase();
    let matchCity = cityKeywords.some(keyword => lowerHTML.includes(keyword));
    let matchKeyword = keywords.some(keyword => lowerHTML.includes(keyword));

    if (matchCity && matchKeyword) {
      totalScore += 10;
      detectedSources.push(source.name);
    }
  });

  await Promise.all(fetches);

  if (totalScore === 0) {
    totalScore = 5; // Minimum si rien trouvé
  }

  totalScore += baseRiskJeunePermis;

  // Cap le résultat à 100 max
  if (totalScore > 100) totalScore = 100;

  document.getElementById('risk').innerText = totalScore + "%";
  document.getElementById('status').innerText = "Données analysées.";

  detectedSources.slice(0, 3).forEach(source => {
    const li = document.createElement('li');
    li.innerText = source;
    document.getElementById('sourcesList').appendChild(li);
  });
}

document.getElementById('city').addEventListener('change', (e) => {
  analyzeCity(e.target.value);
});

// Lancer au démarrage
analyzeCity(document.getElementById('city').value);
</script>
</body>
</html>
