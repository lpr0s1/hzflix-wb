<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
  <div class="bg-white rounded-lg shadow-md p-6 w-full max-w-2xl text-center">
    <h1 class="text-4xl font-bold mb-4">Contrôles de police en Temps Réel</h1>

    <div class="mb-6">
      <select id="citySelect" class="p-2 rounded border">
        <option value="lille">Lille</option>
        <option value="valenciennes">Valenciennes</option>
        <option value="douai">Douai</option>
        <option value="arras">Arras</option>
        <option value="lens">Lens</option>
      </select>
    </div>

    <p id="status" class="text-gray-700 mb-4 text-2xl">Chargement des données...</p>
    <div id="risk" class="text-9xl font-bold text-blue-600 mb-6"></div>

    <div id="sources" class="text-left">
      <h2 class="text-xl font-bold mb-2">Sources analysées :</h2>
      <ul id="sourceList" class="list-disc list-inside text-gray-700"></ul>
    </div>
  </div>

<script>
const citySelect = document.getElementById('citySelect');
const status = document.getElementById('status');
const riskDisplay = document.getElementById('risk');
const sourceList = document.getElementById('sourceList');

const sources = [
  "https://www.radars-auto.com/",
  "https://www.francebleu.fr/",
  "https://www.infotrafic.com/",
  "https://www.autoroutes.fr/fr/etat-du-trafic.htm",
  "https://www.rocade-lille.fr/",
  "https://www.lavoixdunord.fr/",
  "https://www.waze.com/fr/live-map/",
  "https://www.tomtom.com/fr_fr/traffic-index/",
  "https://www.linternaute.com/auto/accident/",
  "https://www.ouest-france.fr/",
  "https://actu.fr/",
  "https://www.franceinfo.fr/faits-divers/",
  "https://www.lavoixdunord.fr/recherche?query=police",
  "https://twitter.com/PoliceNat59",
  "https://twitter.com/gendarmerie",
  "https://www.google.com/search?q=contrôle+police+lille",
  "https://www.google.com/search?q=radar+mobile+lille",
  "https://www.google.com/search?q=controle+police+valenciennes",
  "https://www.google.com/search?q=radar+mobile+valenciennes",
  "https://www.lobservateur.fr/",
  "https://www.20minutes.fr/",
  "https://www.leparisien.fr/faits-divers/",
  "https://www.lunion.fr/",
  "https://www.futura-sciences.com/sciences/actualites/faits-divers",
  "https://www.europe1.fr/faits-divers",
  "https://www.bfmtv.com/faits-divers/",
  "https://www.francetvinfo.fr/faits-divers/",
  "https://www.lavoixdunord.fr/",
  "https://www.sudouest.fr/faits-divers/",
  "https://www.nicematin.com/faits-divers"
];

async function fetchAndAnalyze(city) {
  status.innerText = 'Scraping en cours...';
  sourceList.innerHTML = '';
  let detectionCount = 0;
  const now = new Date();
  const hour = now.getHours();
  const day = now.getDay();
  
  const keywords = ["contrôle", "police", "gendarmerie", "radar", "barrage", "filtrage"];
  const proxy = "https://corsproxy.io/?" ;

  for (let src of sources) {
    try {
      const response = await fetch(proxy + encodeURIComponent(src));
      const text = await response.text();
      const cityLower = city.toLowerCase();
      const isDetected = keywords.some(keyword => text.toLowerCase().includes(keyword) && text.toLowerCase().includes(cityLower));
      
      const li = document.createElement('li');
      li.innerHTML = `<strong>${new URL(src).hostname}</strong> (${now.toLocaleTimeString()}): ${isDetected ? '✅ Détection' : '❌ Rien'}`;
      sourceList.appendChild(li);

      if (isDetected) detectionCount++;
    } catch (err) {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${new URL(src).hostname}</strong>: ⚠️ Erreur d'accès`;
      sourceList.appendChild(li);
    }
  }

  let baseRisk = (detectionCount / sources.length) * 100;
  if (baseRisk > 100) baseRisk = 100;

  // Ajustements selon ton profil jeune permis
  baseRisk += 20; // jeune permis boost
  if (day === 5 || day === 6) baseRisk += 10; // vendredi/samedi
  if (hour >= 7 && hour <= 9 || hour >= 16 && hour <= 19) baseRisk += 5; // heures de pointe
  
  baseRisk = Math.min(Math.round(baseRisk), 100);

  riskDisplay.innerText = `${baseRisk}%`;
  status.innerText = 'Mise à jour effectuée.';
}

citySelect.addEventListener('change', () => {
  fetchAndAnalyze(citySelect.value);
});

fetchAndAnalyze(citySelect.value);
setInterval(() => fetchAndAnalyze(citySelect.value), 60000);
</script>

</body>
</html>
