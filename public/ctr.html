<!DOCTYPE html>
<html lang="fr" translate="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Risque de Contrôle - Live</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
  <div class="bg-white rounded-lg shadow-md p-6 w-full max-w-lg text-center">
    <h1 class="text-4xl font-bold mb-4">Contrôles en Direct</h1>
    
    <select id="city" class="border p-2 rounded mb-6">
      <option value="lille">Lille</option>
      <option value="valenciennes">Valenciennes</option>
      <option value="douai">Douai</option>
      <option value="arras">Arras</option>
    </select>
    
    <p id="status" class="text-gray-700 mb-4 text-3xl">Chargement...</p>
    <div id="risk" class="text-9xl font-bold text-blue-600 mb-4"></div>
    <div id="source" class="text-sm text-gray-500 mt-2"></div>
  </div>

<script>
const sourcesByCity = {
  lille: [
    {
      name: "Radarbot Lille",
      url: "https://corsproxy.io/?https://www.radarbot.net/fr/reportes-en-directo/",
      parser: parseRadarbot
    },
    {
      name: "TomTom Traffic Lille",
      url: "https://corsproxy.io/?https://www.tomtom.com/fr_fr/trafic/",
      parser: parseTomTom
    }
  ],
  valenciennes: [
    {
      name: "Radarbot Valenciennes",
      url: "https://corsproxy.io/?https://www.radarbot.net/fr/reportes-en-directo/",
      parser: parseRadarbot
    }
  ],
  douai: [
    {
      name: "Radarbot Douai",
      url: "https://corsproxy.io/?https://www.radarbot.net/fr/reportes-en-directo/",
      parser: parseRadarbot
    }
  ],
  arras: [
    {
      name: "Radarbot Arras",
      url: "https://corsproxy.io/?https://www.radarbot.net/fr/reportes-en-directo/",
      parser: parseRadarbot
    }
  ]
};

async function fetchFromSources(city) {
  const status = document.getElementById('status');
  const riskDisplay = document.getElementById('risk');
  const sourceDisplay = document.getElementById('source');

  status.innerText = "Chargement...";
  riskDisplay.innerText = "";
  sourceDisplay.innerText = "";

  const sources = sourcesByCity[city] || [];

  for (const source of sources) {
    try {
      const response = await fetch(source.url);
      if (!response.ok) continue;
      const html = await response.text();
      const percent = source.parser(html, city);
      if (percent !== null) {
        displayResult(percent, source.name);
        return;
      }
    } catch (e) {
      console.error('Erreur sur', source.name, e);
    }
  }

  status.innerText = "Aucune donnée trouvée.";
  riskDisplay.innerText = "??%";
  sourceDisplay.innerText = "";
}

function parseRadarbot(html, city) {
  const matches = html.match(new RegExp(city, 'gi')) || [];
  if (matches.length === 0) return null;
  return Math.min(100, matches.length * 12);
}

function parseTomTom(html) {
  const countAlerts = (html.match(/Contrôle/g) || []).length;
  if (countAlerts === 0) return null;
  return Math.min(100, countAlerts * 8);
}

function displayResult(percent, sourceName) {
  document.getElementById('status').innerText = "Données récupérées.";
  document.getElementById('risk').innerText = `${percent}%`;
  document.getElementById('source').innerText = `Source : ${sourceName}`;
}

document.getElementById('city').addEventListener('change', (e) => {
  fetchFromSources(e.target.value);
});

fetchFromSources('lille');
setInterval(() => {
  const city = document.getElementById('city').value;
  fetchFromSources(city);
}, 60000);
</script>

</body>
</html>
