<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>cryptedhype – Chiffrement & Déchiffrement</title>
  <meta name="description" content="cryptedhype : chiffrez et déchiffrez vos fichiers (.txt, .pdf, .jpg, .apk…) en PGP directement dans votre navigateur.">
  <meta name="keywords" content="PGP,chiffrement,fichiers,cryptographie,encrypted,security">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#ff0000">
  <meta property="og:title" content="cryptedhype">
  <meta property="og:description" content="Chiffrez et déchiffrez vos fichiers en PGP sans quitter la page.">
  <meta property="og:url" content="https://hzflix.online/cryptedhype">
  <meta property="og:type" content="website">

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center p-6">

  <h1 class="text-4xl font-bold mb-8 text-red-600">cryptedhype</h1>

  <!-- Section chiffrement -->
  <section id="encrypt-section" class="w-full max-w-md mb-12">
    <h2 class="text-2xl mb-4 text-red-600">Chiffrer un fichier</h2>
    <input
      type="file"
      id="encrypt-input"
      class="w-full mb-4 text-sm file:bg-red-600 file:text-white file:px-4 file:py-2 file:rounded"
    />
    <div id="encrypt-result" class="flex flex-col space-y-4"></div>
  </section>

  <!-- Section déchiffrement -->
  <section id="decrypt-section" class="w-full max-w-md">
    <h2 class="text-2xl mb-4 text-red-600">Déchiffrer un fichier</h2>
    <input
      type="file"
      id="decrypt-input"
      class="w-full mb-2 text-sm file:bg-red-600 file:text-white file:px-4 file:py-2 file:rounded"
    />
    <textarea
      id="private-key"
      rows="4"
      placeholder="Collez ici votre clé privée PGP"
      class="w-full mb-4 p-2 bg-gray-800 text-sm text-white rounded"
    ></textarea>
    <button
      id="decrypt-btn"
      class="w-full px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors duration-200"
    >
      Déchiffrer
    </button>
    <div id="decrypt-result" class="flex flex-col space-y-4 mt-4"></div>
  </section>

  <!-- Librairies externes -->
  <script src="https://cdn.jsdelivr.net/npm/openpgp@5.7.0/dist/openpgp.min.js"></script>

  <script>
    // UTILITAIRE URL (facultatif)
    const URL_SECRET = "hzflixParamKey";
    function getDecryptedParam(key) {
      const raw = new URLSearchParams(location.search).get(key);
      if (!raw) return null;
      try {
        return CryptoJS.AES.decrypt(raw, URL_SECRET)
          .toString(CryptoJS.enc.Utf8);
      } catch {
        return null;
      }
    }
    // Masquer/en afficher selon ?token=...
    const mode = getDecryptedParam("token");
    if (mode === "enc") document.getElementById("decrypt-section").classList.add("hidden");
    if (mode === "dec") document.getElementById("encrypt-section").classList.add("hidden");

    // CHIFFREMENT AUTOMATIQUE AU CHANGE
    document.getElementById("encrypt-input").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const data = new Uint8Array(await file.arrayBuffer());

        // Génération paire PGP
        const { privateKey, publicKey } = await openpgp.generateKey({
          userIDs: [{ name: "cryptedhype User", email: "user@hzflix.online" }],
          curve: "curve25519"
        });

        // Chiffrement
        const publicKeyObj = await openpgp.readKey({ armoredKey: publicKey });
        const message = await openpgp.Message.fromBinary(data);
        const encrypted = await openpgp.encrypt({
          message,
          encryptionKeys: publicKeyObj,
          config: { allowUnauthenticatedStream: true }
        });

        // Préparer lien de téléchargement
        const blob = new Blob([encrypted], { type: "application/pgp-encrypted" });
        const downloadLink = document.createElement("a");
        const url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.download = file.name + ".pgp";
        downloadLink.textContent = "Télécharger le fichier chiffré";
        downloadLink.className = "text-red-400 hover:underline";

        // Afficher clé privée + bouton copier
        const privDiv = document.createElement("div");
        privDiv.className = "flex flex-col";

        const pre = document.createElement("pre");
        pre.textContent = privateKey;
        pre.className = "bg-gray-800 text-white p-2 text-sm overflow-auto max-h-48 whitespace-pre-wrap break-all rounded";

        const copyBtn = document.createElement("button");
        copyBtn.textContent = "Copier la clé privée";
        copyBtn.className = "mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors duration-200";
        copyBtn.addEventListener("click", () => {
          navigator.clipboard.writeText(privateKey);
          copyBtn.textContent = "Clé copiée !";
        });

        privDiv.append(pre, copyBtn);

        // Afficher tout
        const result = document.getElementById("encrypt-result");
        result.innerHTML = "";
        result.append(downloadLink, privDiv);

      } catch (err) {
        alert("Erreur lors du chiffrement : " + err.message);
      }
    });

    // DÉCHIFFREMENT AU CLIC
    document.getElementById("decrypt-btn").addEventListener("click", async () => {
      const fileInput = document.getElementById("decrypt-input");
      const privKeyArmored = document.getElementById("private-key").value.trim();
      if (!fileInput.files.length || !privKeyArmored) {
        return alert("Veuillez fournir le fichier chiffré et la clé privée.");
      }

      try {
        const file = fileInput.files[0];
        const encryptedData = await file.arrayBuffer();

        // Lecture clé privée
        const privateKeyObj = await openpgp.readPrivateKey({ armoredKey: privKeyArmored });

        // Lecture & déchiffrement
        const message = await openpgp.readMessage({ binaryMessage: new Uint8Array(encryptedData) });
        const { data: decrypted } = await openpgp.decrypt({
          message,
          decryptionKeys: privateKeyObj,
          format: "binary"
        });

        // Préparer lien de téléchargement
        const outName = file.name.replace(/\.pgp$/i, "") || "decrypted.dat";
        const blob = new Blob([decrypted]);
        const downloadLink = document.createElement("a");
        const url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.download = outName;
        downloadLink.textContent = "Télécharger le fichier déchiffré";
        downloadLink.className = "text-red-400 hover:underline";

        const result = document.getElementById("decrypt-result");
        result.innerHTML = "";
        result.append(downloadLink);

      } catch (err) {
        alert("Erreur lors du déchiffrement : " + err.message);
      }
    });
  </script>
</body>
</html>

